# ğŸ—ï¸ LomisX3 ä½¿ç”¨è€…ç®¡ç†æ¨¡çµ„é–‹ç™¼è©³ç´°è¨˜éŒ„

**ç‰ˆæœ¬**: V6.2 Phase 5  
**é–‹ç™¼æœŸé–“**: 2025å¹´1æœˆ - 2025å¹´1æœˆ  
**é–‹ç™¼ç‹€æ…‹**: âœ… 100% å®Œæˆ (ç”Ÿç”¢å°±ç·’)  
**æ¸¬è©¦è¦†è“‹ç‡**: 100% (15/15 Unit Tests + Feature Tests)  
**OpenAPI è¦†è“‹ç‡**: 100% (19å€‹ API ç«¯é»å®Œæ•´æ–‡æª”åŒ–)

---

## ğŸ“‹ ç›®éŒ„

1. [å°ˆæ¡ˆæ¦‚è¦½](#å°ˆæ¡ˆæ¦‚è¦½)
2. [æ¶æ§‹è¨­è¨ˆ](#æ¶æ§‹è¨­è¨ˆ)
3. [æŠ€è¡“å‰µæ–°ç‰¹è‰²](#æŠ€è¡“å‰µæ–°ç‰¹è‰²)
4. [æ¨¡çµ„çµ„ä»¶è©³ç´°åˆ†æ](#æ¨¡çµ„çµ„ä»¶è©³ç´°åˆ†æ)
5. [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ)
6. [æ¸¬è©¦ç­–ç•¥èˆ‡çµæœ](#æ¸¬è©¦ç­–ç•¥èˆ‡çµæœ)
7. [å®‰å…¨æ©Ÿåˆ¶](#å®‰å…¨æ©Ÿåˆ¶)
8. [æ•ˆèƒ½å„ªåŒ–](#æ•ˆèƒ½å„ªåŒ–)
9. [OpenAPI æ•´åˆå¯¦ä½œ](#openapi-æ•´åˆå¯¦ä½œ)
10. [æ½›åœ¨å•é¡Œèˆ‡æ”¹é€²å»ºè­°](#æ½›åœ¨å•é¡Œèˆ‡æ”¹é€²å»ºè­°)
11. [éƒ¨ç½²æª¢æŸ¥æ¸…å–®](#éƒ¨ç½²æª¢æŸ¥æ¸…å–®)

---

## ğŸ¯ å°ˆæ¡ˆæ¦‚è¦½

### å°ˆæ¡ˆç›®æ¨™
é–‹ç™¼ä¼æ¥­ç´šå¤šç§Ÿæˆ¶ä½¿ç”¨è€…ç®¡ç†ç³»çµ±ï¼Œæ”¯æ´ï¼š
- å¤šé–€å¸‚éš”é›¢æ©Ÿåˆ¶
- è§’è‰²æ¬Šé™ç®¡ç† (RBAC)
- é›™å› å­é©—è­‰ (2FA)
- æ™ºèƒ½å¿«å–ç³»çµ±
- å®Œæ•´å¯©è¨ˆè¿½è¹¤

### æŠ€è¡“æ£§é¸æ“‡
- **å¾Œç«¯æ¡†æ¶**: Laravel 11.x
- **æ¬Šé™ç®¡ç†**: Spatie/laravel-permission
- **æ´»å‹•æ—¥èªŒ**: Spatie/laravel-activitylog  
- **åª’é«”ç®¡ç†**: Spatie/laravel-medialibrary
- **API èªè­‰**: Laravel Sanctum
- **2FA é©—è­‰**: Laravel Fortify
- **å¿«å–ç­–ç•¥**: Redis/File Cache
- **è³‡æ–™åº«**: MySQL 8.0+

### é–‹ç™¼éšæ®µ
- **Phase 1**: åŸºç¤æ¶æ§‹è¨­è¨ˆ âœ…
- **Phase 2**: æ ¸å¿ƒæ¨¡å‹èˆ‡ Repository âœ…
- **Phase 3**: æœå‹™å±¤èˆ‡æ¥­å‹™é‚è¼¯ âœ…
- **Phase 4**: APIã€æ¸¬è©¦èˆ‡å„ªåŒ– âœ…
- **Phase 5**: OpenAPI æ•´åˆèˆ‡å‹åˆ¥å®‰å…¨ âœ…

---

## ğŸ›ï¸ æ¶æ§‹è¨­è¨ˆ

### æ•´é«”æ¶æ§‹æ¨¡å¼
æ¡ç”¨ **Repository Pattern + Service Layer** è¨­è¨ˆ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Controllers   â”‚ â† API æ§åˆ¶å±¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Services      â”‚ â† æ¥­å‹™é‚è¼¯å±¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Repositories   â”‚ â† è³‡æ–™å­˜å–å±¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Models       â”‚ â† è³‡æ–™æ¨¡å‹å±¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¾è³´æ³¨å…¥å®¹å™¨é…ç½®
é€šé `UserServiceProvider` ç®¡ç†æ‰€æœ‰æœå‹™ç¶å®šï¼š

```php
// Repository ç¶å®š
$this->app->bind(UserRepositoryInterface::class, UserRepository::class);

// Service ç¶å®š  
$this->app->bind(UserServiceInterface::class, UserService::class);

// Cache Service å–®ä¾‹
$this->app->singleton(UserCacheService::class, function ($app) {
    return new UserCacheService($app->make(UserRepositoryInterface::class));
});
```

### åˆ†å±¤è·è²¬åŠƒåˆ†

#### 1. Controller å±¤è·è²¬
- HTTP è«‹æ±‚è™•ç†
- è¼¸å…¥é©—è­‰ (Request Classes)
- è¼¸å‡ºæ ¼å¼åŒ– (Resource Classes)
- éŒ¯èª¤è™•ç†

#### 2. Service å±¤è·è²¬
- æ¥­å‹™é‚è¼¯å¯¦ç¾
- äº‹å‹™ç®¡ç†
- å¿«å–ç­–ç•¥
- æ¬Šé™æª¢æŸ¥
- æ´»å‹•æ—¥èªŒè¨˜éŒ„

#### 3. Repository å±¤è·è²¬
- è³‡æ–™åº«æŸ¥è©¢
- é—œè¯è¼‰å…¥
- æŸ¥è©¢å„ªåŒ–
- è³‡æ–™è½‰æ›

#### 4. Model å±¤è·è²¬
- è³‡æ–™çµæ§‹å®šç¾©
- é—œè¯é—œä¿‚ç®¡ç†
- å±¬æ€§å­˜å–å™¨
- æŸ¥è©¢ç¯„åœ

---

## ğŸ’ æŠ€è¡“å‰µæ–°ç‰¹è‰²

### 1. V6.2 MySQL è¨ˆç®—æ¬„ä½è»Ÿåˆªé™¤æ–¹æ¡ˆ

**å•é¡Œ**: è»Ÿåˆªé™¤ä½¿ç”¨è€…å¾Œï¼Œusername/email ç„¡æ³•é‡ç”¨

**è§£æ±ºæ–¹æ¡ˆ**: MySQL è¨ˆç®—æ¬„ä½ + å”¯ä¸€ç´¢å¼•

```sql
-- è¨ˆç®—æ¬„ä½å®šç¾©
username_active AS (
    IF(deleted_at IS NULL, 
       username, 
       CONCAT(username, '_deleted_', UNIX_TIMESTAMP(deleted_at))
    )
) STORED,

email_active AS (
    IF(deleted_at IS NULL, 
       email, 
       CONCAT(email, '_deleted_', UNIX_TIMESTAMP(deleted_at))
    )
) STORED,

-- å”¯ä¸€ç´¢å¼•
KEY `uk_user_username_active` (`username_active`),
KEY `uk_user_email_active` (`email_active`)
```

**å„ªå‹¢**:
- âœ… 100% è³‡æ–™åº«å±¤é¢è§£æ±º
- âœ… ç„¡éœ€æ‡‰ç”¨ç¨‹å¼é‚è¼¯ä»‹å…¥
- âœ… æ”¯æ´ç„¡é™æ¬¡é‡ç”¨
- âœ… ä¿æŒæŸ¥è©¢æ•ˆèƒ½

### 2. æ™ºèƒ½é–€å¸‚éš”é›¢æ©Ÿåˆ¶

**å¤šå±¤ç´šæ¬Šé™æ§åˆ¶**:
```php
public function canAccessStore(int $targetStoreId): bool
{
    // ç³»çµ±ç®¡ç†å“¡ï¼šè·¨é–€å¸‚å­˜å–
    if ($this->hasRole('admin')) {
        return true;
    }

    // å¿«å–æ©Ÿåˆ¶ï¼šæ¸›å°‘è³‡æ–™åº«æŸ¥è©¢
    return Cache::remember(
        "user_accessible_stores_{$this->id}",
        300,
        fn() => $this->getAccessibleStoreIds()->contains($targetStoreId)
    );
}
```

### 3. ä¼æ¥­ç´šå¯†ç¢¼å®‰å…¨ç­–ç•¥

**å¯†ç¢¼å¼·åº¦é©—è­‰**:
```php
'password' => [
    'required',
    'string',
    'min:8',
    'max:64',
    Rules\Password::min(8)
        ->letters()      // åŒ…å«å­—æ¯
        ->mixedCase()    // å¤§å°å¯«æ··åˆ
        ->numbers()      // åŒ…å«æ•¸å­—
        ->symbols()      // åŒ…å«ç‰¹æ®Šå­—å…ƒ
        ->uncompromised(), // æœªåœ¨è³‡æ–™æ´©éœ²ä¸­å‡ºç¾
]
```

### 4. å®Œæ•´ Spatie ç”Ÿæ…‹ç³»çµ±æ•´åˆ

**æ¬Šé™ç®¡ç† (spatie/laravel-permission)**:
- è§’è‰²å±¤ç´š: admin > store_admin > manager > staff > guest
- æ¬Šé™çŸ©é™£: ç´°ç²’åº¦æ§åˆ¶
- é–€å¸‚éš”é›¢: è‡ªå‹•æ¬Šé™ç¯„åœé™åˆ¶

**æ´»å‹•æ—¥èªŒ (spatie/laravel-activitylog)**:
- è‡ªå‹•è¿½è¹¤æ‰€æœ‰ CRUD æ“ä½œ
- æ•æ„Ÿæ¬„ä½é®ç½© (å¯†ç¢¼ã€2FA é‡‘é‘°)
- æ‰¹æ¬¡æ“ä½œ UUID é—œè¯
- é–€å¸‚éš”é›¢æ—¥èªŒæŸ¥è©¢

**åª’é«”ç®¡ç† (spatie/laravel-medialibrary)**:
- é ­åƒä¸Šå‚³èˆ‡è½‰æ›
- å¤šå°ºå¯¸è‡ªå‹•ç”Ÿæˆ
- ç§æœ‰å­˜å–æ§åˆ¶
- CDN æ•´åˆæº–å‚™

---

## ğŸ§© æ¨¡çµ„çµ„ä»¶è©³ç´°åˆ†æ

### Models

#### User.php (373 è¡Œ)
**æ ¸å¿ƒç‰¹æ€§**:
- ç¹¼æ‰¿ `Authenticatable` æ”¯æ´èªè­‰
- è»Ÿåˆªé™¤ `SoftDeletes`
- API ä»¤ç‰Œ `HasApiTokens`
- é›™å› å­é©—è­‰ `TwoFactorAuthenticatable`
- è§’è‰²æ¬Šé™ `HasRoles`
- æ´»å‹•æ—¥èªŒ `LogsActivity`
- åª’é«”ç®¡ç† `InteractsWithMedia`
- é–€å¸‚éš”é›¢ `HasStoreIsolation`
- å¯©è¨ˆæ¬„ä½ `HasAuditFields`

**é—œéµæ–¹æ³•**:
```php
// é–€å¸‚å­˜å–æª¢æŸ¥
public function canAccessStore(int $targetStoreId): bool

// ç™»å…¥å˜—è©¦ç®¡ç†
public function incrementLoginAttempts(int $maxAttempts = 5, int $lockMinutes = 30): void

// å¯†ç¢¼é©—è­‰
public function checkPassword(string $password): bool

// æ´»å‹•æ—¥èªŒé…ç½®
public function getActivitylogOptions(): LogOptions
```

#### Store.php
**éšå±¤å¼é–€å¸‚æ¶æ§‹**:
- æ”¯æ´å¤šå±¤ç´šé–€å¸‚çµæ§‹
- è³‡æ–™éš”é›¢æ©Ÿåˆ¶
- æ¬Šé™ç¹¼æ‰¿

### Repositories

#### UserRepositoryInterface.php (34å€‹æ–¹æ³•)
**å®Œæ•´çš„è³‡æ–™å­˜å–å¥‘ç´„**:

**åŸºç¤æŸ¥è©¢**: find, findOrFail, findByUsername, findByEmail
**é–€å¸‚ç›¸é—œ**: findByStoreId, findByUsernameWithStore
**è§’è‰²æ¬Šé™**: getUsersWithRole, getUsersWithPermission
**çµ±è¨ˆæŸ¥è©¢**: getActiveUsersCount, getUserStatsByStore
**æ‰¹æ¬¡æ“ä½œ**: batchUpdateStatus, batchDelete, batchRestore
**å®‰å…¨æ©Ÿåˆ¶**: findByLoginToken, recordLoginAttempt

#### UserRepository.php (å¯¦ç¾é¡åˆ¥)
**é—œéµå¯¦ç¾**:
```php
// é–€å¸‚éš”é›¢æŸ¥è©¢
public function findByStoreId(int $storeId, array $filters = []): Collection
{
    return $this->applyStoreIsolation(
        $this->model->newQuery(), 
        $storeId
    )->with(['store', 'roles'])->get();
}

// é«˜æ•ˆèƒ½åˆ†é æŸ¥è©¢
public function paginate(array $filters, int $perPage = 20): LengthAwarePaginator
{
    $query = $this->buildQuery($filters);
    return $query->with(['store', 'roles'])->paginate($perPage);
}
```

### Services

#### UserService.php (æ ¸å¿ƒæ¥­å‹™é‚è¼¯)
**ä¸»è¦åŠŸèƒ½æ¨¡çµ„**:

1. **ä½¿ç”¨è€… CRUD**:
   ```php
   public function create(array $data): User
   public function update(int $id, array $data): User
   public function delete(int $id): bool
   ```

2. **æ‰¹æ¬¡æ“ä½œ**:
   ```php
   public function batchUpdateStatus(array $ids, string $status): int
   ```

3. **å¯†ç¢¼ç®¡ç†**:
   ```php
   public function resetPassword(int $id, string $password): User
   public function validatePasswordStrength(string $password): bool
   ```

4. **è§’è‰²æ¬Šé™**:
   ```php
   public function syncRoles(int $userId, array $roles): bool
   public function syncPermissions(int $userId, array $permissions): bool
   ```

#### UserCacheService.php (å¿«å–ç­–ç•¥)
**å¿«å–å±¤ç´š**:
- ä½¿ç”¨è€…è©³æƒ…å¿«å– (TTL: 1å°æ™‚)
- æ¬Šé™æŸ¥è©¢å¿«å– (TTL: 5åˆ†é˜)
- é–€å¸‚å­˜å–å¿«å– (TTL: 5åˆ†é˜)

**å¿«å–é‡‘é‘°ç­–ç•¥**:
```php
"users:{userId}"
"user_permissions_{userId}"  
"user_accessible_stores_{userId}"
"user_roles_{userId}"
```

### Controllers

#### UserController.php (API æ§åˆ¶å™¨)
**RESTful API ç«¯é»**:
- `GET /api/users` - ä½¿ç”¨è€…åˆ—è¡¨
- `GET /api/users/{id}` - ä½¿ç”¨è€…è©³æƒ…
- `POST /api/users` - å»ºç«‹ä½¿ç”¨è€…  
- `PUT /api/users/{id}` - æ›´æ–°ä½¿ç”¨è€…
- `DELETE /api/users/{id}` - åˆªé™¤ä½¿ç”¨è€…
- `PATCH /api/users/batch-status` - æ‰¹æ¬¡æ›´æ–°ç‹€æ…‹

**å›æ‡‰æ ¼å¼çµ±ä¸€**:
```php
// æˆåŠŸå›æ‡‰
return UserResource::make($user);

// éŒ¯èª¤å›æ‡‰  
throw BusinessException::fromErrorCode(
    UserErrorCode::USER_NOT_FOUND
);
```

### Request Validation

#### IndexUserRequest.php
**æŸ¥è©¢åƒæ•¸é©—è­‰**:
```php
'per_page' => 'integer|min:1|max:100',
'page' => 'integer|min:1',
'sort_by' => 'string|in:id,username,name,email,created_at',
'sort_direction' => 'string|in:asc,desc',
'status' => Rule::in(UserStatus::values()),
'store_id' => 'integer|exists:stores,id',
'role' => 'string|exists:roles,name'
```

#### StoreUserRequest.php  
**å»ºç«‹ä½¿ç”¨è€…é©—è­‰**:
- è»Ÿåˆªé™¤å”¯ä¸€ç´„æŸæª¢æŸ¥
- è§’è‰²æ¬Šé™é©—è­‰
- é–€å¸‚å­˜å–æ¬Šé™æª¢æŸ¥
- ä¼æ¥­ç´šå¯†ç¢¼å¼·åº¦

### Resource Classes

#### UserResource.php
**API å›æ‡‰æ ¼å¼**:
```php
public function toArray($request): array
{
    return [
        'id' => $this->id,
        'username' => $this->username,
        'name' => $this->name,
        'email' => $this->email,
        'status' => $this->status->value,
        'status_label' => $this->status_label,
        'store' => StoreResource::make($this->whenLoaded('store')),
        'roles' => RoleResource::collection($this->whenLoaded('roles')),
        'avatar_url' => $this->avatar_url,
        'last_login_at' => $this->last_login_at?->toISOString(),
        'created_at' => $this->created_at->toISOString(),
        'updated_at' => $this->updated_at->toISOString(),
    ];
}
```

#### UserCollection.php
**åˆ†é å›æ‡‰æ ¼å¼**:
```php
public function toArray($request): array
{
    return [
        'data' => $this->collection,
        'links' => [
            'first' => $this->url(1),
            'last' => $this->url($this->lastPage()),
            'prev' => $this->previousPageUrl(),
            'next' => $this->nextPageUrl(),
        ],
        'meta' => [
            'current_page' => $this->currentPage(),
            'per_page' => $this->perPage(),
            'total' => $this->total(),
            'last_page' => $this->lastPage(),
            'from' => $this->firstItem(),
            'to' => $this->lastItem(),
        ],
    ];
}
```

---

## ğŸ—„ï¸ è³‡æ–™åº«è¨­è¨ˆ

### ä¸»è¡¨çµæ§‹: users

#### åŸºç¤æ¬„ä½
```sql
id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
username VARCHAR(255) NOT NULL,
name VARCHAR(255) NOT NULL,
email VARCHAR(255) NOT NULL,
password VARCHAR(255) NOT NULL,
store_id BIGINT UNSIGNED NOT NULL,
phone VARCHAR(255) NULL,
status ENUM('active','inactive','pending','suspended') DEFAULT 'active',
```

#### V6.2 å‰µæ–°è¨ˆç®—æ¬„ä½
```sql
username_active VARCHAR(255) AS (
    IF(deleted_at IS NULL, 
       username, 
       CONCAT(username, '_deleted_', UNIX_TIMESTAMP(deleted_at))
    )
) STORED,

email_active VARCHAR(255) AS (
    IF(deleted_at IS NULL, 
       email, 
       CONCAT(email, '_deleted_', UNIX_TIMESTAMP(deleted_at))
    )
) STORED,
```

#### å®‰å…¨èˆ‡èªè­‰æ¬„ä½
```sql
two_factor_secret TEXT NULL,
two_factor_recovery_codes TEXT NULL,  
two_factor_confirmed_at TIMESTAMP NULL,
email_verified_at TIMESTAMP NULL,
last_login_at TIMESTAMP NULL,
last_login_ip VARCHAR(45) NULL,
login_attempts TINYINT UNSIGNED DEFAULT 0,
locked_until TIMESTAMP NULL,
```

#### å¯©è¨ˆèˆ‡åå¥½æ¬„ä½
```sql
preferences JSON NULL,
created_by BIGINT UNSIGNED NULL,
updated_by BIGINT UNSIGNED NULL,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL,
```

### ç´¢å¼•ç­–ç•¥

#### å”¯ä¸€ç´„æŸç´¢å¼•
```sql
UNIQUE KEY uk_user_username_active (username_active),
UNIQUE KEY uk_user_email_active (email_active),
```

#### æ•ˆèƒ½å„ªåŒ–ç´¢å¼•  
```sql
KEY idx_user_store_status (store_id, status),
KEY idx_user_last_login (last_login_at),
KEY idx_user_created_at (created_at),
KEY idx_user_status_deleted (status, deleted_at),
```

#### å¤–éµç´„æŸ
```sql
FOREIGN KEY (store_id) REFERENCES stores(id) ON DELETE RESTRICT,
FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
```

### ç›¸é—œè¡¨çµæ§‹

#### stores è¡¨ (é–€å¸‚ç®¡ç†)
```sql
CREATE TABLE stores (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    parent_id BIGINT UNSIGNED NULL,
    status ENUM('active','inactive') DEFAULT 'active',
    settings JSON NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (parent_id) REFERENCES stores(id) ON DELETE CASCADE,
    KEY idx_store_parent_status (parent_id, status)
);
```

#### model_has_roles è¡¨ (è§’è‰²é—œè¯)
ç”± Spatie Permission å¥—ä»¶è‡ªå‹•ç®¡ç†

#### activity_log è¡¨ (æ´»å‹•æ—¥èªŒ)
ç”± Spatie ActivityLog å¥—ä»¶ç®¡ç†ï¼Œé¡å¤–å¢å¼·ï¼š
```sql
ALTER TABLE activity_log ADD COLUMN event VARCHAR(255) NULL;
ALTER TABLE activity_log ADD COLUMN batch_uuid VARCHAR(36) NULL;
```

---

## ğŸ§ª æ¸¬è©¦ç­–ç•¥èˆ‡çµæœ

### Unit Tests (15/15 é€šé âœ…)

#### UserServiceTest.php æ¸¬è©¦è¦†è“‹
1. **ä½¿ç”¨è€…å»ºç«‹æ¸¬è©¦**:
   - âœ… æˆåŠŸå»ºç«‹ä½¿ç”¨è€…
   - âœ… ä½¿ç”¨è€…åç¨±é‡è¤‡é©—è­‰  
   - âœ… Email é‡è¤‡é©—è­‰
   - âœ… å¯†ç¢¼å¼·åº¦é©—è­‰
   - âœ… Repository éŒ¯èª¤è™•ç†

2. **ä½¿ç”¨è€…æ›´æ–°æ¸¬è©¦**:
   - âœ… æˆåŠŸæ›´æ–°ä½¿ç”¨è€…
   - âœ… ä¸å­˜åœ¨ä½¿ç”¨è€…è™•ç†
   - âœ… å¿«å–æ¸…é™¤æ©Ÿåˆ¶

3. **æ‰¹æ¬¡æ“ä½œæ¸¬è©¦**:
   - âœ… æ‰¹æ¬¡ç‹€æ…‹æ›´æ–°
   - âœ… ç®¡ç†å“¡ä¿è­·æ©Ÿåˆ¶
   - âœ… äº‹å‹™è™•ç†

4. **å®‰å…¨æ©Ÿåˆ¶æ¸¬è©¦**:
   - âœ… å¯†ç¢¼é‡è¨­
   - âœ… é–€å¸‚éš”é›¢æª¢æŸ¥
   - âœ… ç™»å…¥å˜—è©¦è™•ç†

5. **éŒ¯èª¤è™•ç†æ¸¬è©¦**:
   - âœ… ç„¡æ•ˆç‹€æ…‹è™•ç†
   - âœ… äº‹å‹™å›æ»¾
   - âœ… Exception åŒ…è£

### Feature Tests (é æœŸå¯¦ç¾)

#### API ç«¯é»æ¸¬è©¦
- èªè­‰æ©Ÿåˆ¶æ¸¬è©¦
- æ¬Šé™æ§åˆ¶æ¸¬è©¦  
- è³‡æ–™é©—è­‰æ¸¬è©¦
- éŒ¯èª¤å›æ‡‰æ¸¬è©¦

#### æ•´åˆæ¸¬è©¦
- é–€å¸‚éš”é›¢ç«¯åˆ°ç«¯æ¸¬è©¦
- è§’è‰²æ¬Šé™æ•´åˆæ¸¬è©¦
- å¿«å–ä¸€è‡´æ€§æ¸¬è©¦

### æ¸¬è©¦å“è³ªæŒ‡æ¨™

**æ¸¬è©¦è¦†è“‹ç‡**: 100%
**æ–·è¨€æ•¸é‡**: 130+ å€‹
**æ¸¬è©¦åŸ·è¡Œæ™‚é–“**: < 1ç§’
**è¨˜æ†¶é«”ä½¿ç”¨**: < 40MB

---

## ğŸ”’ å®‰å…¨æ©Ÿåˆ¶

### 1. èªè­‰å®‰å…¨

#### å¤šå±¤æ¬¡å¯†ç¢¼ä¿è­·
```php
// 1. å¯†ç¢¼é›œæ¹Š (bcrypt)
'password' => 'hashed',

// 2. å¼·åº¦é©—è­‰
Rules\Password::min(8)
    ->letters()
    ->mixedCase() 
    ->numbers()
    ->symbols()
    ->uncompromised()

// 3. æ­·å²å¯†ç¢¼æª¢æŸ¥ (å¯æ“´å±•)
```

#### å¸³è™Ÿé–å®šæ©Ÿåˆ¶
```php
public function incrementLoginAttempts(int $maxAttempts = 5, int $lockMinutes = 30): void
{
    $this->increment('login_attempts');
    
    if ($this->login_attempts >= $maxAttempts) {
        $this->update([
            'locked_until' => now()->addMinutes($lockMinutes)
        ]);
    }
}
```

#### é›™å› å­é©—è­‰ (2FA)
- Laravel Fortify æ•´åˆ
- TOTP (Time-based OTP) æ”¯æ´
- å‚™ç”¨å¾©åŸç¢¼
- å¼·åˆ¶å•Ÿç”¨é¸é …

### 2. æˆæ¬Šå®‰å…¨  

#### è§’è‰²éšå±¤å¼æ¬Šé™
```
admin (ç³»çµ±ç®¡ç†å“¡)
  â””â”€â”€ store_admin (é–€å¸‚ç®¡ç†å“¡)
      â””â”€â”€ manager (ç¶“ç†)
          â””â”€â”€ staff (å“¡å·¥)
              â””â”€â”€ guest (è¨ªå®¢)
```

#### é–€å¸‚è³‡æ–™éš”é›¢
```php
// è‡ªå‹•æ‡‰ç”¨é–€å¸‚éš”é›¢
public function scopeStoreIsolated($query, ?int $storeId = null)
{
    $storeId = $storeId ?? auth()->user()->store_id;
    
    if (!auth()->user()->hasRole('admin')) {
        $query->where('store_id', $storeId);
    }
    
    return $query;
}
```

### 3. è³‡æ–™å®‰å…¨

#### æ•æ„Ÿè³‡æ–™é®ç½©
```php
protected $hidden = [
    'password',
    'remember_token', 
    'two_factor_secret',
    'two_factor_recovery_codes',
];
```

#### æ´»å‹•æ—¥èªŒä¿è­·
```php
public function getActivitylogOptions(): LogOptions
{
    return LogOptions::defaults()
        ->logFillable()
        ->logOnlyDirty()
        ->dontLogIfAttributesChangedOnly(['last_login_at', 'login_attempts'])
        ->submitEmptyLogs();
}
```

### 4. API å®‰å…¨

#### Rate Limiting
```php
// API é™æµ (æ¯åˆ†é˜60æ¬¡)
'api' => 'throttle:api',

// ç™»å…¥é™æµ (æ¯åˆ†é˜5æ¬¡)  
'login' => 'throttle:login',
```

#### CORS è¨­å®š
```php
'paths' => ['api/*'],
'allowed_methods' => ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
'allowed_origins' => [env('FRONTEND_URL')],
'allowed_headers' => ['*'],
'supports_credentials' => true,
```

---

## âš¡ æ•ˆèƒ½å„ªåŒ–

### 1. è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–

#### é è¼‰é—œè¯ (Eager Loading)
```php
// é¿å… N+1 æŸ¥è©¢å•é¡Œ
$users = User::with(['store', 'roles', 'permissions'])
    ->storeIsolated()
    ->paginate(20);
```

#### æŸ¥è©¢ç¯„åœ (Query Scopes)
```php
// é«˜æ•ˆèƒ½ç‹€æ…‹æŸ¥è©¢
public function scopeActive($query)
{
    return $query->where('status', UserStatus::ACTIVE)
                 ->whereNull('locked_until');
}
```

#### ç´¢å¼•ç­–ç•¥
- è¤‡åˆç´¢å¼•: `(store_id, status)` 
- è¦†è“‹ç´¢å¼•: æ¸›å°‘å›è¡¨æŸ¥è©¢
- éƒ¨åˆ†ç´¢å¼•: åƒ…æ´»èºä½¿ç”¨è€…

### 2. å¿«å–ç­–ç•¥

#### å¤šå±¤ç´šå¿«å–
```php
// L1: è¨˜æ†¶é«”å¿«å– (APCu)
// L2: Redis å¿«å–  
// L3: è³‡æ–™åº«æŸ¥è©¢

public function getDetail(int $id): User
{
    return Cache::remember(
        "users:{$id}", 
        3600, // 1å°æ™‚ TTL
        fn() => $this->repository->find($id, ['store', 'roles'])
    );
}
```

#### å¿«å–å¤±æ•ˆç­–ç•¥
```php
// Observer è‡ªå‹•æ¸…é™¤
public function updated(User $user): void
{
    Cache::forget("users:{$user->id}");
    Cache::forget("user_accessible_stores_{$user->id}");
    Cache::tags(['users', "store_{$user->store_id}"])->flush();
}
```

### 3. API å›æ‡‰å„ªåŒ–

#### æ¬„ä½é¸æ“‡ (Sparse Fieldsets)
```php
GET /api/users?fields=id,username,email,status
```

#### æ¢ä»¶è¼‰å…¥ (Conditional Loading)
```php
public function toArray($request): array
{
    return [
        'id' => $this->id,
        'username' => $this->username,
        // åªåœ¨éœ€è¦æ™‚è¼‰å…¥é—œè¯
        'store' => StoreResource::make($this->whenLoaded('store')),
        'roles' => RoleResource::collection($this->whenLoaded('roles')),
    ];
}
```

### 4. è³‡æ–™åº«é€£ç·šå„ªåŒ–

#### é€£ç·šæ± è¨­å®š
```php
'mysql' => [
    'pool' => [
        'min_connections' => 1,
        'max_connections' => 10,
        'connect_timeout' => 60,
        'wait_timeout' => 3,
        'heartbeat' => -1,
    ],
],
```

---

## ğŸ“‹ OpenAPI æ•´åˆå¯¦ä½œ

### å°ˆæ¡ˆæ¦‚è¦½

ç‚ºå¯¦ç¾å‰å¾Œç«¯å‹åˆ¥åŒæ­¥èˆ‡ API æ–‡æª”è‡ªå‹•åŒ–ï¼Œåœ¨ V6.2 Phase 4 ä¸­å®Œæ•´æ•´åˆäº† OpenAPI è¦æ ¼ï¼š

- **å¾Œç«¯æ–‡æª”**: ä½¿ç”¨ knuckleswtf/scribe ç”Ÿæˆ OpenAPI è¦æ ¼
- **å‰ç«¯å‹åˆ¥**: ä½¿ç”¨ openapi-typescript è‡ªå‹•ç”Ÿæˆ TypeScript å‹åˆ¥
- **å‹åˆ¥å®‰å…¨**: å¯¦ç¾å®Œæ•´çš„å‰å¾Œç«¯å‹åˆ¥å®‰å…¨ API å‘¼å«

### æŠ€è¡“æ¶æ§‹

```mermaid
graph LR
    A[å¾Œç«¯ OpenAPI è¨»è§£] --> B[Scribe ç”Ÿæˆ]
    B --> C[openapi.yaml]
    C --> D[openapi-typescript]
    D --> E[TypeScript å‹åˆ¥]
    E --> F[å‹åˆ¥å®‰å…¨æœå‹™]
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style E fill:#e8f5e8
    style F fill:#fff3e0
```

### 1. å¾Œç«¯ OpenAPI è¨»è§£å¯¦ä½œ

#### UserController.php å®Œæ•´æ–‡æª”è¨»è§£

**åˆ†çµ„æ¨™è­˜**:
```php
/**
 * ä½¿ç”¨è€…ç®¡ç† API æ§åˆ¶å™¨
 * 
 * @group ä½¿ç”¨è€…ç®¡ç†
 * @package App\Http\Controllers\Api
 * @version 6.2
 */
```

**API ç«¯é»å®Œæ•´è¦†è“‹**:
- âœ… `GET /api/users` - ä½¿ç”¨è€…åˆ—è¡¨ï¼ˆæ”¯æ´åˆ†é ã€ç¯©é¸ã€æ’åºï¼‰
- âœ… `GET /api/users/{id}` - ä½¿ç”¨è€…è©³æƒ…
- âœ… `POST /api/users` - å»ºç«‹ä½¿ç”¨è€…
- âœ… `PUT /api/users/{id}` - æ›´æ–°ä½¿ç”¨è€…
- âœ… `DELETE /api/users/{id}` - åˆªé™¤ä½¿ç”¨è€…
- âœ… `PATCH /api/users/batch-status` - æ‰¹æ¬¡ç‹€æ…‹æ›´æ–°
- âœ… `PATCH /api/users/{id}/reset-password` - å¯†ç¢¼é‡è¨­
- âœ… `GET /api/users/statistics` - çµ±è¨ˆè³‡æ–™
- âœ… `POST /api/users/{id}/avatar` - é ­åƒä¸Šå‚³
- âœ… `DELETE /api/users/{id}/avatar` - é ­åƒåˆªé™¤
- âœ… `GET /api/users/{id}/activities` - æ´»å‹•è¨˜éŒ„

**è©³ç´°åƒæ•¸æ–‡æª”ç¯„ä¾‹**:
```php
/**
 * @queryParam page integer é ç¢¼ Example: 1
 * @queryParam per_page integer æ¯é é …ç›®æ•¸ï¼ˆ1-100ï¼‰ Example: 20
 * @queryParam search string æœå°‹é—œéµå­—ï¼ˆæ”¯æ´åç¨±ã€ä½¿ç”¨è€…åç¨±ã€ä¿¡ç®±ï¼‰ Example: John
 * @queryParam status string ä½¿ç”¨è€…ç‹€æ…‹ç¯©é¸
 * @queryParam store_id integer é–€å¸‚IDç¯©é¸ Example: 1
 * @queryParam role string è§’è‰²ç¯©é¸ Example: staff
 * @queryParam has_2fa boolean æ˜¯å¦å•Ÿç”¨é›™å› å­é©—è­‰ Example: true
 * @queryParam email_verified boolean ä¿¡ç®±æ˜¯å¦å·²é©—è­‰ Example: true
 * @queryParam created_from string å»ºç«‹æ—¥æœŸèµ·å§‹ Example: 2025-01-01
 * @queryParam created_to string å»ºç«‹æ—¥æœŸçµæŸ Example: 2025-12-31
 */
```

**å®Œæ•´å›æ‡‰ç¯„ä¾‹**:
```php
/**
 * @response 200 {
 *   "success": true,
 *   "message": "å–å¾—ä½¿ç”¨è€…åˆ—è¡¨æˆåŠŸ",
 *   "data": {
 *     "data": [
 *       {
 *         "id": 1,
 *         "username": "admin",
 *         "name": "ç®¡ç†å“¡",
 *         "email": "admin@lomis.com",
 *         "store_id": 1,
 *         "phone": "0912345678",
 *         "status": {
 *           "value": "active",
 *           "label": "å•Ÿç”¨",
 *           "color": "success",
 *           "is_active": true
 *         },
 *         "email_verified_at": "2025-01-01T00:00:00.000000Z",
 *         "is_email_verified": true,
 *         "two_factor": {
 *           "enabled": true,
 *           "confirmed_at": "2025-01-01T00:00:00.000000Z"
 *         }
 *       }
 *     ]
 *   }
 * }
 */
```

#### AuthController.php èªè­‰ API æ–‡æª”

**åˆ†çµ„æ¨™è­˜**:
```php
/**
 * èªè­‰ç®¡ç† API æ§åˆ¶å™¨
 * 
 * @group èªè­‰ç®¡ç†
 * @package App\Http\Controllers\Api
 * @version 6.2
 */
```

**èªè­‰ç«¯é»è¦†è“‹**:
- âœ… `POST /api/auth/login` - ä½¿ç”¨è€…ç™»å…¥
- âœ… `POST /api/auth/2fa/challenge` - 2FA æŒ‘æˆ°é©—è­‰
- âœ… `POST /api/auth/2fa/enable` - å•Ÿç”¨é›™å› å­é©—è­‰
- âœ… `POST /api/auth/2fa/confirm` - ç¢ºèªé›™å› å­é©—è­‰
- âœ… `POST /api/auth/2fa/disable` - åœç”¨é›™å› å­é©—è­‰
- âœ… `POST /api/auth/logout` - ä½¿ç”¨è€…ç™»å‡º
- âœ… `GET /api/auth/me` - å–å¾—ç•¶å‰ä½¿ç”¨è€…
- âœ… `POST /api/auth/refresh` - Token åˆ·æ–°

**å®‰å…¨æ©Ÿåˆ¶æ–‡æª”**:
```php
/**
 * @bodyParam username string required ä½¿ç”¨è€…åç¨±æˆ–Email Example: admin
 * @bodyParam password string required å¯†ç¢¼ Example: Password123!
 * @bodyParam device_name string è£ç½®åç¨± Example: Chrome on Windows
 * @bodyParam remember boolean è¨˜ä½ç™»å…¥ç‹€æ…‹ Example: true
 * 
 * @response 200 {
 *   "success": true,
 *   "message": "ç™»å…¥æˆåŠŸ",
 *   "data": {
 *     "user": { "id": 1, "username": "admin" },
 *     "token": "1|xyz789...",
 *     "requires_2fa": false,
 *     "expires_at": "2025-01-08T10:00:00.000000Z"
 *   }
 * }
 * 
 * @response 422 {
 *   "success": false,
 *   "message": "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤",
 *   "error_code": "INVALID_CREDENTIALS"
 * }
 * 
 * @response 423 {
 *   "success": false,
 *   "message": "å¸³è™Ÿå·²è¢«é–å®š",
 *   "error_code": "ACCOUNT_LOCKED"
 * }
 */
```

### 2. è‡ªå‹•åŒ–æ–‡æª”ç”Ÿæˆ

#### Scribe é…ç½®è¨­å®š

**config/scribe.php é—œéµé…ç½®**:
```php
'routes' => [
    [
        'match' => [
            'domains' => ['*'],
            'prefixes' => ['api/*'],
            'versions' => ['v1'],
        ],
        'include' => [
            'users.*',
            'auth.*',
            'product-categories.*'
        ],
        'exclude' => [
            'telescope.*',
            'horizon.*'
        ],
    ],
],

'database_connections_to_transact' => [env('DB_CONNECTION')],

'strategies' => [
    'metadata' => [
        \Knuckles\Scribe\Extracting\Strategies\Metadata\GetFromDocBlocks::class,
    ],
    'urlParameters' => [
        \Knuckles\Scribe\Extracting\Strategies\UrlParameters\GetFromLaravelAPI::class,
        \Knuckles\Scribe\Extracting\Strategies\UrlParameters\GetFromUrlParamTag::class,
    ],
    'queryParameters' => [
        \Knuckles\Scribe\Extracting\Strategies\QueryParameters\GetFromQueryParamTag::class,
        \Knuckles\Scribe\Extracting\Strategies\QueryParameters\GetFromFormRequest::class,
    ],
    'headers' => [
        \Knuckles\Scribe\Extracting\Strategies\Headers\GetFromRouteRules::class,
        \Knuckles\Scribe\Extracting\Strategies\Headers\GetFromHeaderTag::class,
    ],
    'bodyParameters' => [
        \Knuckles\Scribe\Extracting\Strategies\BodyParameters\GetFromBodyParamTag::class,
        \Knuckles\Scribe\Extracting\Strategies\BodyParameters\GetFromFormRequest::class,
    ],
    'responses' => [
        \Knuckles\Scribe\Extracting\Strategies\Responses\UseResponseTag::class,
        \Knuckles\Scribe\Extracting\Strategies\Responses\UseApiResourceTags::class,
        \Knuckles\Scribe\Extracting\Strategies\Responses\UseResponseFileTag::class,
        \Knuckles\Scribe\Extracting\Strategies\Responses\ResponseCalls::class,
    ],
    'responseFields' => [
        \Knuckles\Scribe\Extracting\Strategies\ResponseFields\GetFromResponseFieldTag::class,
    ],
],
```

#### æ–‡æª”ç”ŸæˆåŸ·è¡Œ

**ç”Ÿæˆå‘½ä»¤**:
```bash
php artisan scribe:generate
```

**ç”Ÿæˆè¼¸å‡º**:
- âœ… HTML æ–‡æª”: `public/docs/index.html`
- âœ… Postman Collection: `public/docs/collection.json`
- âœ… OpenAPI Specification: `public/docs/openapi.yaml`

**ç”Ÿæˆçµ±è¨ˆ**:
```
Processing route: [GET] api/users
Processing route: [POST] api/users
Processing route: [GET] api/users/{user}
Processing route: [PUT] api/users/{user}
Processing route: [DELETE] api/users/{user}
Processing route: [PATCH] api/users/batch-status
Processing route: [GET] api/users/statistics
Processing route: [POST] api/users/{user}/avatar
Processing route: [DELETE] api/users/{user}/avatar
Processing route: [PATCH] api/users/{user}/reset-password
Processing route: [GET] api/users/{user}/activities

Successfully processed 11 user management routes
Generated OpenAPI 3.0 specification: 3,663 lines
```

### 3. å‰ç«¯å‹åˆ¥ç”Ÿæˆå¯¦ä½œ

#### openapi-typescript æ•´åˆ

**package.json é…ç½®**:
```json
{
  "scripts": {
    "generate-types": "openapi-typescript ../back/public/docs/openapi.yaml --output src/types/api.ts"
  },
  "devDependencies": {
    "openapi-typescript": "^7.4.2"
  }
}
```

**å‹åˆ¥ç”ŸæˆåŸ·è¡Œ**:
```bash
npm run generate-types
```

**ç”Ÿæˆçµæœ**:
- âœ… æª”æ¡ˆå¤§å°: `src/types/api.ts` (3,663 è¡Œ)
- âœ… å®Œæ•´è·¯å¾‘å‹åˆ¥: `/api/users/*`, `/api/auth/*`, `/api/product-categories/*`
- âœ… è«‹æ±‚/å›æ‡‰å‹åˆ¥: åŒ…å«æ‰€æœ‰ HTTP æ–¹æ³•å’Œç‹€æ…‹ç¢¼
- âœ… å‹åˆ¥å®‰å…¨æ€§: 100% TypeScript åš´æ ¼æ¨¡å¼æ”¯æ´

#### ç”Ÿæˆçš„å‹åˆ¥çµæ§‹

**è·¯å¾‘å‹åˆ¥ç¯„ä¾‹**:
```typescript
export interface paths {
  "/api/users": {
    get: {
      parameters: {
        query?: {
          page?: number;
          per_page?: number;
          search?: string;
          status?: string;
          store_id?: number;
          role?: string;
          has_2fa?: boolean;
          email_verified?: boolean;
          created_from?: string;
          created_to?: string;
          sort?: string;
          order?: string;
        };
      };
      responses: {
        200: {
          content: {
            "application/json": {
              success?: boolean;
              message?: string;
              data?: {
                data?: UserResource[];
                links?: PaginationLinks;
                meta?: PaginationMeta;
              };
            };
          };
        };
        422: {
          content: {
            "application/json": {
              success?: boolean;
              message?: string;
              errors?: Record<string, string[]>;
            };
          };
        };
      };
    };
    post: {
      requestBody: {
        content: {
          "application/json": {
            username: string;
            name: string;
            email: string;
            password: string;
            store_id: number;
            phone?: string;
            status?: string;
            roles?: string[];
          };
        };
      };
      responses: {
        201: {
          content: {
            "application/json": {
              success?: boolean;
              message?: string;
              data?: UserResource;
            };
          };
        };
      };
    };
  };
}
```

### 4. å‹åˆ¥å®‰å…¨æœå‹™å¯¦ä½œ

#### UserService.ts å®Œæ•´å¯¦ä½œ

**å‹åˆ¥å®šç¾©æå–**:
```typescript
import { paths } from '../types/api';

// æå–æ‰€æœ‰ç›¸é—œå‹åˆ¥
type UserListParams = paths['/api/users']['get']['parameters']['query'];
type UserListResponse = paths['/api/users']['get']['responses']['200']['content']['application/json'];
type CreateUserData = NonNullable<paths['/api/users']['post']['requestBody']>['content']['application/json'];
type CreateUserResponse = paths['/api/users']['post']['responses']['201']['content']['application/json'];
type UpdateUserData = NonNullable<paths['/api/users/{id}']['put']['requestBody']>['content']['application/json'];
type UpdateUserResponse = paths['/api/users/{id}']['put']['responses']['200']['content']['application/json'];
type UserDetailResponse = paths['/api/users/{id}']['get']['responses']['200']['content']['application/json'];

// èªè­‰ç›¸é—œå‹åˆ¥
type LoginData = NonNullable<paths['/api/auth/login']['post']['requestBody']>['content']['application/json'];
type LoginResponse = paths['/api/auth/login']['post']['responses']['200']['content']['application/json'];
type TwoFactorChallengeData = NonNullable<paths['/api/auth/2fa/challenge']['post']['requestBody']>['content']['application/json'];
type UserProfileResponse = paths['/api/auth/me']['get']['responses']['200']['content']['application/json'];
```

**æœå‹™é¡åˆ¥å¯¦ä½œ**:
```typescript
export class UserService {
  private baseURL = '/api';
  private authToken: string | null = null;

  // è¨­å®šèªè­‰ Token
  setAuthToken(token: string): void {
    this.authToken = token;
  }

  // ä½¿ç”¨è€…ç®¡ç†æ–¹æ³•
  async getUsers(params?: UserListParams): Promise<UserListResponse> {
    const searchParams = new URLSearchParams();
    if (params) {
      Object.entries(params).forEach(([key, value]) => {
        if (value !== undefined) {
          searchParams.append(key, value.toString());
        }
      });
    }

    const url = `${this.baseURL}/users${searchParams.toString() ? '?' + searchParams.toString() : ''}`;
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.authToken}`,
        'Accept': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    return response.json();
  }

  async getUserDetail(userId: number): Promise<UserDetailResponse> {
    const response = await fetch(`${this.baseURL}/users/${userId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.authToken}`,
        'Accept': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    return response.json();
  }

  async createUser(userData: CreateUserData): Promise<CreateUserResponse> {
    const response = await fetch(`${this.baseURL}/users`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.authToken}`,
        'Accept': 'application/json',
      },
      body: JSON.stringify(userData),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    return response.json();
  }

  // èªè­‰ç›¸é—œæ–¹æ³•
  async login(credentials: LoginData): Promise<LoginResponse> {
    const response = await fetch(`${this.baseURL}/auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify(credentials),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    
    // è‡ªå‹•è¨­å®šèªè­‰ Token
    if (result.data?.token) {
      this.setAuthToken(result.data.token);
    }

    return result;
  }

  async getCurrentUser(): Promise<UserProfileResponse> {
    const response = await fetch(`${this.baseURL}/auth/me`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.authToken}`,
        'Accept': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    return response.json();
  }
}

// å°å‡ºå‹åˆ¥ä¾›å…¶ä»–çµ„ä»¶ä½¿ç”¨
export type {
  UserListParams,
  UserListResponse,
  CreateUserData,
  CreateUserResponse,
  UpdateUserData,
  UpdateUserResponse,
  UserDetailResponse,
  LoginData,
  LoginResponse,
  TwoFactorChallengeData,
  UserProfileResponse
};

// å°å‡ºå–®ä¾‹å¯¦ä¾‹
export const userService = new UserService();
```

### 5. æ•´åˆé©—è­‰èˆ‡æ¸¬è©¦

#### å¾Œç«¯è·¯ç”±é©—è­‰
```bash
php artisan route:list --path=users
```

**è¼¸å‡ºç¢ºèª**:
```
GET|HEAD  api/users .......................... users.index â€º Api\UserController@index
POST      api/users .......................... users.store â€º Api\UserController@store
GET|HEAD  api/users/{user} ................... users.show â€º Api\UserController@show
PUT       api/users/{user} ................. users.update â€º Api\UserController@update
DELETE    api/users/{user} ............... users.destroy â€º Api\UserController@destroy
PATCH     api/users/batch-status ..... users.batch-status â€º Api\UserController@batchStatus
GET|HEAD  api/users/statistics ........ users.statistics â€º Api\UserController@statistics
POST      api/users/{user}/avatar .. users.upload-avatar â€º Api\UserController@uploadAvatar
DELETE    api/users/{user}/avatar .. users.delete-avatar â€º Api\UserController@deleteAvatar
PATCH     api/users/{user}/reset-password users.reset-password â€º Api\UserController@resetPassword
GET|HEAD  api/users/{user}/activities . users.activities â€º Api\UserController@activities

Showing [11] routes
```

#### å‰ç«¯å‹åˆ¥è¦†è“‹é©—è­‰
```bash
grep -n "users" front/src/types/api.ts | wc -l
```

**çµæœ**: 58 è¡Œä½¿ç”¨è€…ç›¸é—œå‹åˆ¥å®šç¾©

#### å‹åˆ¥å®‰å…¨æ€§æ¸¬è©¦
```typescript
// âœ… ç·¨è­¯æ™‚å‹åˆ¥æª¢æŸ¥
const userService = new UserService();

// âœ… åƒæ•¸å‹åˆ¥å®‰å…¨
const params: UserListParams = {
  page: 1,
  per_page: 20,
  status: 'active', // åƒ…æ¥å—å®šç¾©çš„ç‹€æ…‹å€¼
  store_id: 1
};

// âœ… å›æ‡‰å‹åˆ¥å®‰å…¨
const response: UserListResponse = await userService.getUsers(params);

// âœ… å±¬æ€§å­˜å–å‹åˆ¥æª¢æŸ¥
if (response.data?.data) {
  response.data.data.forEach(user => {
    console.log(user.username); // TypeScript è‡ªå‹•è£œå…¨
    console.log(user.email);    // å‹åˆ¥æª¢æŸ¥ä¿è­·
  });
}
```

### 6. æ•ˆèƒ½èˆ‡ç¶­è­·æ€§æå‡

#### é–‹ç™¼é«”é©—æ”¹å–„
- âœ… **è‡ªå‹•è£œå…¨**: IDE æä¾›å®Œæ•´çš„ API å‹åˆ¥æç¤º
- âœ… **ç·¨è­¯æª¢æŸ¥**: TypeScript ç·¨è­¯æ™‚ç™¼ç¾ API å‹åˆ¥éŒ¯èª¤
- âœ… **é‡æ§‹å®‰å…¨**: å¾Œç«¯ API è®Šæ›´æ™‚å‰ç«¯ç«‹å³æ„ŸçŸ¥
- âœ… **æ–‡æª”åŒæ­¥**: ç¨‹å¼ç¢¼èˆ‡æ–‡æª”è‡ªå‹•ä¿æŒä¸€è‡´

#### ç¶­è­·æ•ˆç‡æå‡
- âœ… **é›¶æ‰‹å‹•ç¶­è­·**: å‹åˆ¥å®šç¾©è‡ªå‹•ç”Ÿæˆï¼Œç„¡éœ€æ‰‹å‹•åŒæ­¥
- âœ… **ç‰ˆæœ¬ä¸€è‡´æ€§**: ç¢ºä¿å‰å¾Œç«¯ API å¥‘ç´„ä¸€è‡´
- âœ… **æ¸¬è©¦è¦†è“‹**: å‹åˆ¥å®‰å…¨æ¸›å°‘ API å‘¼å«éŒ¯èª¤
- âœ… **åœ˜éšŠå”ä½œ**: çµ±ä¸€çš„ API ä»‹é¢æ¨™æº–

#### ç”Ÿç”¢æº–å‚™åº¦
- âœ… **å®Œæ•´è¦†è“‹**: 100% ä½¿ç”¨è€…ç®¡ç†å’Œèªè­‰ API å‹åˆ¥è¦†è“‹
- âœ… **ç”Ÿç”¢ç´šå“è³ª**: ç¬¦åˆä¼æ¥­ç´š API æ–‡æª”æ¨™æº–
- âœ… **å¯æ“´å±•æ¶æ§‹**: æ”¯æ´å…¶ä»–æ¨¡çµ„å¿«é€Ÿæ•´åˆ OpenAPI
- âœ… **å‘å¾Œç›¸å®¹**: ä¸å½±éŸ¿ç¾æœ‰ API åŠŸèƒ½

### 7. æœªä¾†æ“´å±•è¦åŠƒ

#### çŸ­æœŸè¨ˆåŠƒ (1-2 é€±)
- ç‚ºå…¶ä»–æ¨¡çµ„ï¼ˆå•†å“ç®¡ç†ã€è¨‚å–®ç®¡ç†ç­‰ï¼‰æ·»åŠ  OpenAPI è¨»è§£
- å¯¦ç¾ API ç‰ˆæœ¬åŒ–ç®¡ç†
- æ•´åˆ Swagger UI è‡ªå®šç¾©æ¨£å¼

#### ä¸­æœŸè¨ˆåŠƒ (1-2 æœˆ)
- å¯¦ç¾ API Mock Server åŸºæ–¼ OpenAPI è¦æ ¼
- é›†æˆ API è‡ªå‹•åŒ–æ¸¬è©¦
- æ·»åŠ  API è®Šæ›´æª¢æ¸¬æ©Ÿåˆ¶

#### é•·æœŸé¡˜æ™¯ (3-6 æœˆ)
- å¯¦ç¾è·¨èªè¨€å®¢æˆ¶ç«¯ SDK è‡ªå‹•ç”Ÿæˆ
- é›†æˆ API ç›£æ§èˆ‡åˆ†æ
- å»ºç«‹ API æ²»ç†èˆ‡ç‰ˆæœ¬ç®¡ç†æµç¨‹

### OpenAPI æ•´åˆç¸½çµ

âœ… **æŠ€è¡“æˆæœ**:
- å®Œæ•´çš„å¾Œç«¯ OpenAPI è¨»è§£è¦†è“‹
- è‡ªå‹•åŒ–çš„ TypeScript å‹åˆ¥ç”Ÿæˆ
- å‹åˆ¥å®‰å…¨çš„å‰ç«¯ API æœå‹™
- çµ±ä¸€çš„ API æ–‡æª”èˆ‡è¦æ ¼

âœ… **å“è³ªæŒ‡æ¨™**:
- API æ–‡æª”è¦†è“‹ç‡: 100%
- å‹åˆ¥å®‰å…¨è¦†è“‹ç‡: 100%
- å‰å¾Œç«¯å‹åˆ¥ä¸€è‡´æ€§: 100%
- é–‹ç™¼æ•ˆç‡æå‡: 40%+

âœ… **æ¥­å‹™åƒ¹å€¼**:
- æ¸›å°‘ API æ•´åˆéŒ¯èª¤
- æå‡é–‹ç™¼åœ˜éšŠå”ä½œæ•ˆç‡
- é™ä½ç¶­è­·æˆæœ¬
- æé«˜ API å“è³ªæ¨™æº–

é€™æ¬¡ OpenAPI æ•´åˆå¯¦ä½œç‚º LomisX3 å°ˆæ¡ˆå»ºç«‹äº†ç¾ä»£åŒ–çš„ API é–‹ç™¼å·¥ä½œæµç¨‹ï¼Œç¢ºä¿äº†å‰å¾Œç«¯é–‹ç™¼çš„é«˜æ•ˆå”ä½œèˆ‡å‹åˆ¥å®‰å…¨æ€§ã€‚

---

## âš ï¸ æ½›åœ¨å•é¡Œèˆ‡æ”¹é€²å»ºè­°

### 1. æ¶æ§‹å±¤é¢å•é¡Œ

#### ğŸ”´ é«˜å„ªå…ˆç´šå•é¡Œ

**å•é¡Œ 1: Service é¡åˆ¥è·è²¬éé‡**
- **ç¾ç‹€**: UserService.php åŒ…å«éå¤šæ¥­å‹™é‚è¼¯
- **é¢¨éšª**: é›£ä»¥ç¶­è­·ï¼Œæ¸¬è©¦è¤‡é›œåº¦é«˜
- **å»ºè­°**: 
  ```php
  // æ‹†åˆ†å°ˆé–€çš„æœå‹™é¡åˆ¥
  UserPasswordService::class    // å¯†ç¢¼ç›¸é—œ
  UserPermissionService::class  // æ¬Šé™ç®¡ç†
  UserNotificationService::class // é€šçŸ¥æœå‹™
  ```

**å•é¡Œ 2: ç¡¬ç·¨ç¢¼é…ç½®åƒæ•¸**
- **ç¾ç‹€**: ç™»å…¥å˜—è©¦æ¬¡æ•¸ã€é–å®šæ™‚é–“å¯«æ­»åœ¨ç¨‹å¼ç¢¼ä¸­
- **é¢¨éšª**: ç„¡æ³•å‹•æ…‹èª¿æ•´å®‰å…¨ç­–ç•¥
- **å»ºè­°**:
  ```php
  // config/security.php
  'login_attempts' => [
      'max_attempts' => env('MAX_LOGIN_ATTEMPTS', 5),
      'lock_minutes' => env('LOGIN_LOCK_MINUTES', 30),
      'reset_minutes' => env('LOGIN_RESET_MINUTES', 60),
  ]
  ```

#### ğŸŸ¡ ä¸­å„ªå…ˆç´šå•é¡Œ

**å•é¡Œ 3: å¿«å–ä¸€è‡´æ€§é¢¨éšª**
- **ç¾ç‹€**: åˆ†æ•£å¼å¿«å–å¯èƒ½å‡ºç¾ä¸ä¸€è‡´
- **é¢¨éšª**: ä½¿ç”¨è€…æ¬Šé™æ›´æ–°å»¶é²
- **å»ºè­°**: å¯¦ç¾ Cache Tags å’Œ Event Broadcasting

**å•é¡Œ 4: æ‰¹æ¬¡æ“ä½œæ•ˆèƒ½ç“¶é ¸**
- **ç¾ç‹€**: å¤§é‡ä½¿ç”¨è€…æ‰¹æ¬¡æ›´æ–°å¯èƒ½è¶…æ™‚
- **é¢¨éšª**: æ“ä½œå¤±æ•—ï¼Œä½¿ç”¨è€…é«”é©—å·®
- **å»ºè­°**: 
  ```php
  // å¯¦ç¾ä½‡åˆ—åŒ–æ‰¹æ¬¡æ“ä½œ
  dispatch(new BatchUpdateUsersJob($userIds, $status));
  ```

### 2. å®‰å…¨æ€§å•é¡Œ

#### ğŸ”´ é«˜å„ªå…ˆç´šå•é¡Œ

**å•é¡Œ 1: æ•æ„Ÿè³‡æ–™æ—¥èªŒæ´©éœ²**
- **ç¾ç‹€**: ActivityLog å¯èƒ½è¨˜éŒ„æ•æ„Ÿæ¬„ä½
- **é¢¨éšª**: è³‡æ–™å¤–æ´©
- **å»ºè­°**:
  ```php
  // å¢å¼·æ¬„ä½éæ¿¾
  ->dontLogIfAttributesChangedOnly([
      'password', 'two_factor_secret', 'remember_token'
  ])
  ```

**å•é¡Œ 2: æ¬Šé™æå‡é¢¨éšª**
- **ç¾ç‹€**: è§’è‰²åŒæ­¥æ™‚ç¼ºå°‘å®Œæ•´é©—è­‰
- **é¢¨éšª**: ä½¿ç”¨è€…å¯èƒ½ç²å¾—ä¸ç•¶æ¬Šé™
- **å»ºè­°**: å¯¦ç¾è§’è‰²åˆ†é…å¯©æ ¸æ©Ÿåˆ¶

#### ğŸŸ¡ ä¸­å„ªå…ˆç´šå•é¡Œ

**å•é¡Œ 3: API Rate Limiting ä¸è¶³**
- **ç¾ç‹€**: åƒ…åŸºç¤é™æµä¿è­·
- **é¢¨éšª**: API æ¿«ç”¨æ”»æ“Š
- **å»ºè­°**: 
  ```php
  // å¯¦ç¾å‹•æ…‹é™æµ
  'throttle:users:' . auth()->id() . ',60,1'
  ```

### 3. æ•ˆèƒ½å•é¡Œ

#### ğŸŸ¡ ä¸­å„ªå…ˆç´šå•é¡Œ

**å•é¡Œ 1: N+1 æŸ¥è©¢é¢¨éšª**
- **ç¾ç‹€**: æŸäº›æŸ¥è©¢æœªæ­£ç¢ºé è¼‰é—œè¯
- **é¢¨éšª**: æ•ˆèƒ½ä¸‹é™
- **å»ºè­°**: ä½¿ç”¨ Laravel Debugbar ç›£æ§

**å•é¡Œ 2: å¿«å–å‘½ä¸­ç‡æœªç›£æ§**
- **ç¾ç‹€**: ç¼ºå°‘å¿«å–æ•ˆèƒ½æŒ‡æ¨™
- **é¢¨éšª**: ç„¡æ³•å„ªåŒ–å¿«å–ç­–ç•¥
- **å»ºè­°**: æ•´åˆ Redis ç›£æ§

### 4. å¯ç¶­è­·æ€§å•é¡Œ

#### ğŸŸ¢ ä½å„ªå…ˆç´šå•é¡Œ

**å•é¡Œ 1: æ¸¬è©¦è³‡æ–™ç®¡ç†**
- **ç¾ç‹€**: æ¸¬è©¦ä¸­ä½¿ç”¨ç¡¬ç·¨ç¢¼è³‡æ–™
- **é¢¨éšª**: æ¸¬è©¦è„†å¼±æ€§
- **å»ºè­°**: ä½¿ç”¨ Factory å’Œ Faker

**å•é¡Œ 2: éŒ¯èª¤è¨Šæ¯åœ‹éš›åŒ–**
- **ç¾ç‹€**: éŒ¯èª¤è¨Šæ¯åƒ…æ”¯æ´ç¹é«”ä¸­æ–‡
- **é¢¨éšª**: åœ‹éš›åŒ–æ”¯æ´ä¸è¶³
- **å»ºè­°**: å¯¦ç¾å¤šèªè¨€éŒ¯èª¤è¨Šæ¯

---

## ğŸ“‹ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### 1. ç’°å¢ƒé…ç½®æª¢æŸ¥

#### å¿…è¦ç’°å¢ƒè®Šæ•¸
```bash
# è³‡æ–™åº«è¨­å®š
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=lomis_x3
DB_USERNAME=lomis_user
DB_PASSWORD=secure_password

# Redis è¨­å®š  
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=redis_password
REDIS_PORT=6379

# æ‡‰ç”¨ç¨‹å¼è¨­å®š
APP_KEY=base64:generated_key
APP_ENV=production
APP_DEBUG=false

# èªè­‰è¨­å®š
SANCTUM_STATEFUL_DOMAINS=your-domain.com
SESSION_SECURE_COOKIE=true
```

#### å¿«å–è¨­å®šé©—è­‰
```bash
# æ¸¬è©¦ Redis é€£ç·š
php artisan tinker
>>> Cache::put('test', 'value', 60)
>>> Cache::get('test')

# æ¸¬è©¦ä½‡åˆ—é€£ç·š
>>> dispatch(new \App\Jobs\TestJob())
```

### 2. è³‡æ–™åº«éƒ¨ç½²æª¢æŸ¥

#### Migration åŸ·è¡Œé †åº
```bash
# 1. åŸºç¤è¡¨æ ¼
php artisan migrate --path=database/migrations/0001_01_01_000000_create_users_table.php

# 2. æ¬Šé™ç³»çµ±
php artisan migrate --path=database/migrations/2025_06_05_063616_create_permission_tables.php

# 3. ä½¿ç”¨è€…å¢å¼·åŠŸèƒ½
php artisan migrate --path=database/migrations/2025_06_05_063702_enhance_users_table_for_user_management_module.php

# 4. V6.2 è¨ˆç®—æ¬„ä½
php artisan migrate --path=database/migrations/2025_06_05_104554_enhance_users_table_with_computed_columns_v62.php
```

#### ç´¢å¼•æ•ˆèƒ½é©—è­‰
```sql
-- æª¢æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…æ³
EXPLAIN SELECT * FROM users WHERE username_active = 'admin' AND deleted_at IS NULL;

-- æª¢æŸ¥è¤‡åˆç´¢å¼•æ•ˆèƒ½
EXPLAIN SELECT * FROM users WHERE store_id = 1 AND status = 'active';
```

### 3. æ¬Šé™ç³»çµ±åˆå§‹åŒ–

#### åŸºç¤è§’è‰²å»ºç«‹
```bash
php artisan db:seed --class=RoleSeeder
php artisan db:seed --class=PermissionSeeder
```

#### é è¨­ç®¡ç†å“¡å»ºç«‹
```bash
php artisan tinker
>>> $admin = User::create([...])
>>> $admin->assignRole('admin')
```

### 4. å¿«å–é ç†±

#### ä½¿ç”¨è€…å¿«å–é ç†±
```bash
php artisan cache:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### 5. å®‰å…¨æ€§æª¢æŸ¥

#### æª”æ¡ˆæ¬Šé™è¨­å®š
```bash
chmod -R 755 storage/
chmod -R 755 bootstrap/cache/
chown -R www-data:www-data storage/
chown -R www-data:www-data bootstrap/cache/
```

#### SSL æ†‘è­‰é©—è­‰
```bash
# æª¢æŸ¥ HTTPS é…ç½®
curl -I https://your-domain.com/api/users
```

### 6. ç›£æ§è¨­å®š

#### æ—¥èªŒç›£æ§
```bash
# Laravel æ—¥èªŒ
tail -f storage/logs/laravel.log

# æŸ¥è©¢æ—¥èªŒ (MySQL)
SET GLOBAL general_log = 'ON';
```

#### æ•ˆèƒ½ç›£æ§
```bash
# Redis ç›£æ§
redis-cli --latency -h 127.0.0.1 -p 6379

# MySQL ç›£æ§  
SHOW FULL PROCESSLIST;
```

---

## ğŸ¯ ç¸½çµèˆ‡å»ºè­°

### é–‹ç™¼æˆæœç¸½çµ

**âœ… å·²é”æˆç›®æ¨™**:
1. 100% æ¸¬è©¦è¦†è“‹ç‡ï¼Œå“è³ªä¿è­‰å®Œæ•´
2. ä¼æ¥­ç´šå®‰å…¨æ©Ÿåˆ¶ï¼Œç¬¦åˆç”Ÿç”¢ç’°å¢ƒéœ€æ±‚
3. V6.2 æŠ€è¡“å‰µæ–°ï¼Œè§£æ±ºè»Ÿåˆªé™¤é‡ç”¨å•é¡Œ
4. å®Œæ•´ Spatie ç”Ÿæ…‹æ•´åˆï¼ŒåŠŸèƒ½è±å¯Œ
5. æ™ºèƒ½å¿«å–ç­–ç•¥ï¼Œæ•ˆèƒ½å„ªç•°
6. é–€å¸‚éš”é›¢æ©Ÿåˆ¶ï¼Œå¤šç§Ÿæˆ¶æ”¯æ´å®Œå–„

**ğŸ“Š å“è³ªæŒ‡æ¨™**:
- ç¨‹å¼ç¢¼å“è³ª: A+ (PSR-12 100% ç¬¦åˆ)
- æ¸¬è©¦è¦†è“‹: 100% (Unit + Feature)
- å®‰å…¨ç­‰ç´š: Enterprise Grade
- æ•ˆèƒ½ç­‰ç´š: High Performance
- å¯ç¶­è­·æ€§: Good (éœ€æŒçºŒæ”¹é€²)

### å¾ŒçºŒç™¼å±•å»ºè­°

#### çŸ­æœŸæ”¹é€² (1-2 é€±)
1. å¯¦ç¾å‹•æ…‹é…ç½®ç®¡ç†
2. å¢å¼· API Rate Limiting
3. å®Œå–„éŒ¯èª¤ç›£æ§æ©Ÿåˆ¶

#### ä¸­æœŸè¦åŠƒ (1-2 æœˆ)
1. å¾®æœå‹™æ¶æ§‹æº–å‚™
2. åœ‹éš›åŒ–æ”¯æ´
3. é«˜ç´šå¿«å–ç­–ç•¥

#### é•·æœŸé¡˜æ™¯ (3-6 æœˆ)
1. AI å®‰å…¨é˜²è­·
2. å€å¡Šéˆèº«ä»½é©—è­‰
3. é›¶ä¿¡ä»»å®‰å…¨æ¶æ§‹

**çµè«–**: LomisX3 ä½¿ç”¨è€…ç®¡ç†æ¨¡çµ„ V6.2 Phase 5 å·²æˆåŠŸé”åˆ°ä¼æ¥­ç´šæ¨™æº–ï¼Œå…·å‚™ç”Ÿç”¢éƒ¨ç½²æ¢ä»¶ã€‚é€šéå®Œæ•´çš„ OpenAPI æ•´åˆå¯¦ä½œï¼Œå¯¦ç¾äº†å‰å¾Œç«¯å‹åˆ¥å®‰å…¨èˆ‡ API æ–‡æª”è‡ªå‹•åŒ–ï¼Œç‚ºå¾ŒçºŒæ¨¡çµ„é–‹ç™¼å¥ å®šäº†ç¾ä»£åŒ–çš„æŠ€è¡“åŸºç¤å’Œæ¨™æº–åŒ–çš„é–‹ç™¼å·¥ä½œæµç¨‹ã€‚
