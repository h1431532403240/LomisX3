name: ğŸ” PHPStan æŠ€è¡“å‚µå‹™è¿½è¹¤ (Weekly)

on:
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 8:00 UTC (å°ç£æ™‚é–“ 16:00) åŸ·è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'å»ºç«‹æˆ–æ›´æ–° Issue'
        required: false
        default: true
        type: boolean

jobs:
  phpstan-debt-tracking:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

    - name: Cache Composer packages
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-phpstan-debt-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-phpstan-debt-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-interaction

    - name: Run PHPStan without baseline (æŠ€è¡“å‚µå‹™æƒæ)
      run: |
        echo "ğŸ” åŸ·è¡Œ PHPStan åˆ†æ (ç„¡ baseline æ¨¡å¼)..."
        
        # å»ºç«‹å ±å‘Šç›®éŒ„
        mkdir -p reports
        
        # åŸ·è¡Œ PHPStan åˆ†æï¼Œè¼¸å‡ºåˆ°æª”æ¡ˆ
        ./vendor/bin/phpstan analyse \
          --memory-limit=-1 \
          --error-format=table \
          --no-interaction \
          --ansi \
          > reports/phpstan-analysis.txt 2>&1 || true
        
        # åŒæ™‚ç”Ÿæˆ JSON æ ¼å¼å ±å‘Š
        ./vendor/bin/phpstan analyse \
          --memory-limit=-1 \
          --error-format=json \
          --no-interaction \
          > reports/phpstan-analysis.json 2>&1 || true
        
        echo "âœ… PHPStan åˆ†æå®Œæˆ"

    - name: åˆ†æç•¶å‰ baseline ç‹€æ³
      run: |
        echo "ğŸ“Š åˆ†æ baseline æª”æ¡ˆ..."
        
        if [ -f "phpstan-baseline.neon" ]; then
          baseline_count=$(grep -c "message:" phpstan-baseline.neon || echo 0)
          echo "BASELINE_COUNT=${baseline_count}" >> $GITHUB_ENV
          echo "ç•¶å‰ baseline éŒ¯èª¤æ•¸é‡: ${baseline_count}"
        else
          echo "BASELINE_COUNT=0" >> $GITHUB_ENV
          echo "æœªç™¼ç¾ baseline æª”æ¡ˆ"
        fi

    - name: ç”ŸæˆæŠ€è¡“å‚µå‹™å ±å‘Š
      run: |
        echo "ğŸ“ ç”ŸæˆæŠ€è¡“å‚µå‹™è¿½è¹¤å ±å‘Š..."
        
        # å»ºç«‹å ±å‘Šæª”æ¡ˆ
        cat > reports/debt-report.md << 'EOF'
        # ğŸ“Š PHPStan æŠ€è¡“å‚µå‹™è¿½è¹¤å ±å‘Š
        
        **æƒææ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **Commit**: ${{ github.sha }}
        
        ## ğŸ¯ å‚µå‹™æ¦‚è¦½
        
        | æŒ‡æ¨™ | æ•¸å€¼ | ç›®æ¨™ | ç‹€æ…‹ |
        |------|------|------|------|
        | Baseline éŒ¯èª¤æ•¸ | ${{ env.BASELINE_COUNT }} | â‰¤ 30 | $([ ${{ env.BASELINE_COUNT }} -le 30 ] && echo "âœ… é”æ¨™" || echo "âŒ è¶…æ¨™") |
        | Sprint ç›®æ¨™ | è‡³å°‘æ¸›å°‘ 5 æ¢ | -5 | ğŸ¯ é€²è¡Œä¸­ |
        
        ## ğŸ“ˆ æ”¹é€²å»ºè­°
        
        ### å„ªå…ˆè™•ç†é …ç›®
        1. **å‹åˆ¥å®‰å…¨**: ä¿®æ­£ `argument.type` ç›¸é—œéŒ¯èª¤
        2. **æ–¹æ³•å­˜åœ¨æ€§**: è§£æ±º `method.notFound` å•é¡Œ
        3. **å›å‚³å‹åˆ¥**: ä¿®æ­£ `return.type` ä¸åŒ¹é…
        
        ### éæ¸›ç­–ç•¥
        - æ¯ Sprint è‡³å°‘ç§»é™¤ 5 æ¢ baseline é …ç›®
        - å„ªå…ˆè™•ç†é«˜é¢¨éšªçš„å‹åˆ¥å®‰å…¨å•é¡Œ
        - é€æ­¥æ”¹å–„ç¨‹å¼ç¢¼å“è³ªï¼Œé¿å…æ–°å¢æŠ€è¡“å‚µå‹™
        
        EOF
        
        # å¦‚æœæœ‰ PHPStan è¼¸å‡ºï¼ŒåŠ å…¥è©³ç´°åˆ†æ
        if [ -f "reports/phpstan-analysis.txt" ]; then
          echo "" >> reports/debt-report.md
          echo "## ğŸ” è©³ç´°åˆ†æçµæœ" >> reports/debt-report.md
          echo "" >> reports/debt-report.md
          echo '```' >> reports/debt-report.md
          cat reports/phpstan-analysis.txt >> reports/debt-report.md
          echo '```' >> reports/debt-report.md
        fi
        
        echo "âœ… æŠ€è¡“å‚µå‹™å ±å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šå‚³å ±å‘Š Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: phpstan-debt-report-${{ github.run_number }}
        path: |
          reports/
          phpstan-baseline.neon
        retention-days: 90

    - name: æª¢æŸ¥æ˜¯å¦éœ€è¦å»ºç«‹/æ›´æ–° Issue
      if: github.event.inputs.create_issue != 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è®€å–å‚µå‹™å ±å‘Š
          const reportPath = 'reports/debt-report.md';
          const reportContent = fs.readFileSync(reportPath, 'utf8');
          
          // æŸ¥æ‰¾ç¾æœ‰çš„æŠ€è¡“å‚µå‹™ Issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['technical-debt', 'phpstan']
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes('PHPStan æŠ€è¡“å‚µå‹™è¿½è¹¤')
          );
          
          const issueTitle = 'ğŸ” PHPStan æŠ€è¡“å‚µå‹™è¿½è¹¤ - Baseline éæ¸›è¨ˆç•«';
          const issueBody = `${reportContent}
          
          ## ğŸš€ è¡Œå‹•è¨ˆç•«
          
          - [ ] æœ¬ Sprint ç§»é™¤è‡³å°‘ 5 æ¢ baseline é …ç›®
          - [ ] æ›´æ–° CHANGELOG.md æŠ€è¡“å‚µæ¸…ç†å€å¡Š
          - [ ] åŸ·è¡Œå›æ­¸æ¸¬è©¦ç¢ºä¿ç©©å®šæ€§
          
          ## ğŸ“‹ è¿½è¹¤æ­·å²
          
          | Sprint | é–‹å§‹æ•¸é‡ | çµæŸæ•¸é‡ | æ¸›å°‘æ•¸é‡ | é”æˆç‡ |
          |--------|----------|----------|----------|--------|
          | æœ¬é€± | ${{ env.BASELINE_COUNT }} | TBD | TBD | TBD |
          
          ---
          
          **è‡ªå‹•æ›´æ–°**: æ­¤ Issue ç”± GitHub Actions æ¯é€±è‡ªå‹•æ›´æ–°
          **æœ€å¾Œæ›´æ–°**: ${new Date().toISOString()}
          `;
          
          if (existingIssue) {
            // æ›´æ–°ç¾æœ‰ Issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: issueBody
            });
            
            console.log(`âœ… å·²æ›´æ–°ç¾æœ‰ Issue #${existingIssue.number}`);
          } else {
            // å»ºç«‹æ–° Issue
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['technical-debt', 'phpstan', 'priority:medium']
            });
            
            console.log(`âœ… å·²å»ºç«‹æ–° Issue #${newIssue.data.number}`);
          }

    - name: å·¥ä½œæµç¨‹æ‘˜è¦
      run: |
        echo "### ğŸ” PHPStan æŠ€è¡“å‚µå‹™è¿½è¹¤å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é …ç›® | çµæœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Baseline éŒ¯èª¤æ•¸ | ${{ env.BASELINE_COUNT }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ç›®æ¨™æ¸›å°‘æ•¸é‡ | è‡³å°‘ 5 æ¢/Sprint |" >> $GITHUB_STEP_SUMMARY
        echo "| å ±å‘Šç”Ÿæˆ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
        echo "| Issue æ›´æ–° | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ è©³ç´°å ±å‘Šå·²ä¸Šå‚³è‡³ Artifactsï¼Œå¯ä¸‹è¼‰æŸ¥çœ‹" 