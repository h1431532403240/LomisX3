<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦å¾Œç«¯ Unauthenticated ä¿®å¾© - LomisX3</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ LomisX3 å¾Œç«¯ Unauthenticated ä¿®å¾©æ¸¬è©¦</h1>
        
        <div class="info">
            <strong>ä¿®å¾©èªªæ˜ï¼š</strong><br>
            ä¿®æ”¹äº† <code>back/app/Exceptions/Handler.php</code> ä¸­çš„ <code>unauthenticated</code> æ–¹æ³•ï¼Œ
            ä½¿ API è«‹æ±‚åœ¨æœªèªè­‰æ™‚è¿”å› JSON éŒ¯èª¤è€Œéé‡å®šå‘ï¼Œå¾æ ¹æœ¬è§£æ±º CORS å•é¡Œã€‚
        </div>

        <div class="test-section">
            <h3>ğŸ“¡ æ¸¬è©¦ 1: æœªèªè­‰ API è«‹æ±‚ (æ‡‰è¿”å› JSON 401)</h3>
            <p>æ¸¬è©¦æœªèªè­‰ç‹€æ…‹ä¸‹è¨ªå•éœ€è¦èªè­‰çš„ API ç«¯é»</p>
            <button onclick="testUnauthenticatedAPI()">æ¸¬è©¦æœªèªè­‰ API è«‹æ±‚</button>
            <div id="test1-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”’ æ¸¬è©¦ 2: æ¯”è¼ƒä¿®å¾©å‰å¾Œçš„è¡Œç‚º</h3>
            <p>å±•ç¤ºä¿®å¾©å‰å¾Œ API è«‹æ±‚çš„å·®ç•°</p>
            <button onclick="showBehaviorComparison()">é¡¯ç¤ºè¡Œç‚ºæ¯”è¼ƒ</button>
            <div id="test2-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸŒ æ¸¬è©¦ 3: CORS æª¢æŸ¥</h3>
            <p>é©—è­‰ CORS éŒ¯èª¤æ˜¯å¦å·²è§£æ±º</p>
            <button onclick="testCORSFix()">æ¸¬è©¦ CORS ä¿®å¾©</button>
            <div id="test3-result" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        async function testUnauthenticatedAPI() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.textContent = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦æœªèªè­‰ API è«‹æ±‚...';
            
            try {
                // å˜—è©¦è¨ªå•éœ€è¦èªè­‰çš„ç«¯é»ï¼Œä¸å¸¶ token
                const response = await fetch(`${API_BASE}/auth/user`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        // æ•…æ„ä¸åŒ…å« Authorization header
                    }
                });
                
                const data = await response.json();
                
                if (response.status === 401) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ä¿®å¾©æˆåŠŸï¼
ç‹€æ…‹ç¢¼: ${response.status}
å›æ‡‰æ ¼å¼: JSON
å›æ‡‰å…§å®¹: ${JSON.stringify(data, null, 2)}

èªªæ˜: API æ­£ç¢ºè¿”å› 401 JSON éŒ¯èª¤ï¼Œæ²’æœ‰é‡å®šå‘ï¼`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ æœªé æœŸçš„å›æ‡‰
ç‹€æ…‹ç¢¼: ${response.status}
å›æ‡‰: ${JSON.stringify(data, null, 2)}`;
                }
                
            } catch (error) {
                if (error.message.includes('redirected') || error.message.includes('CORS')) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ CORS éŒ¯èª¤ä»ç„¶å­˜åœ¨ï¼
éŒ¯èª¤: ${error.message}

é€™è¡¨ç¤ºå¾Œç«¯ä»åœ¨é‡å®šå‘ API è«‹æ±‚ï¼Œä¿®å¾©å¯èƒ½æœªæ­£ç¢ºæ‡‰ç”¨ã€‚`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`;
                }
            }
        }
        
        function showBehaviorComparison() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.className = 'result success';
            resultDiv.textContent = `ğŸ“Š ä¿®å¾©å‰å¾Œè¡Œç‚ºæ¯”è¼ƒï¼š

ğŸ”´ ä¿®å¾©å‰ï¼ˆå•é¡Œç‹€æ…‹ï¼‰ï¼š
- API è«‹æ±‚ â†’ 401 æœªèªè­‰
- Laravel é‡å®šå‘åˆ° /login
- ç€è¦½å™¨ CORS éŒ¯èª¤ï¼š"redirected from localhost:8000/api/auth/user to localhost:8000/login"
- å‰ç«¯ç„¡æ³•è™•ç†ï¼Œç”¨æˆ¶çœ‹åˆ°éŒ¯èª¤

âœ… ä¿®å¾©å¾Œï¼ˆæ­£ç¢ºç‹€æ…‹ï¼‰ï¼š
- API è«‹æ±‚ â†’ 401 æœªèªè­‰  
- Handler.php æª¢æŸ¥ expectsJson() = true
- è¿”å› JSON: {"success": false, "message": "Unauthenticated.", "error_code": "UNAUTHENTICATED"}
- å‰ç«¯æ­£ç¢ºæ¥æ”¶ 401 JSONï¼ŒåŸ·è¡Œç›¸æ‡‰è™•ç†ï¼ˆå¦‚é‡å®šå‘åˆ°ç™»å…¥é ï¼‰

ğŸ¯ æ ¸å¿ƒæ”¹é€²ï¼š
- éµå¾ª SPA è¨­è¨ˆåŸå‰‡
- API è«‹æ±‚å§‹çµ‚è¿”å› JSON
- æ¶ˆé™¤ CORS é‡å®šå‘éŒ¯èª¤
- å‰ç«¯å¯æ­£ç¢ºè™•ç†èªè­‰å¤±æ•—`;
        }
        
        async function testCORSFix() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.textContent = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦ CORS ä¿®å¾©...';
            
            try {
                // æ¸¬è©¦å¤šå€‹ API ç«¯é»
                const endpoints = [
                    '/auth/user',
                    '/product-categories',
                    '/users'
                ];
                
                let allPassed = true;
                let results = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.status === 401) {
                            const data = await response.json();
                            results.push(`âœ… ${endpoint}: æ­£ç¢ºè¿”å› 401 JSON`);
                        } else {
                            results.push(`âš ï¸ ${endpoint}: ç‹€æ…‹ç¢¼ ${response.status}`);
                        }
                        
                    } catch (error) {
                        if (error.message.includes('redirected') || error.message.includes('CORS')) {
                            allPassed = false;
                            results.push(`âŒ ${endpoint}: CORS éŒ¯èª¤ - ${error.message}`);
                        } else {
                            results.push(`âš ï¸ ${endpoint}: ç¶²è·¯éŒ¯èª¤ - ${error.message}`);
                        }
                    }
                }
                
                if (allPassed) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `ğŸ‰ CORS ä¿®å¾©é©—è­‰æˆåŠŸï¼

${results.join('\n')}

çµè«–: æ‰€æœ‰æ¸¬è©¦çš„ API ç«¯é»éƒ½æ­£ç¢ºè¿”å› JSON å›æ‡‰ï¼Œæ²’æœ‰ CORS é‡å®šå‘éŒ¯èª¤ã€‚
Handler.php çš„ unauthenticated æ–¹æ³•ä¿®å¾©å·²ç”Ÿæ•ˆï¼`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ éƒ¨åˆ†ç«¯é»ä»æœ‰å•é¡Œï¼š

${results.join('\n')}`;
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æ¸¬è©¦éç¨‹å‡ºéŒ¯: ${error.message}`;
            }
        }
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºèªªæ˜
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ LomisX3 å¾Œç«¯ Unauthenticated ä¿®å¾©æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦ä¿®å¾©æ•ˆæœ');
        });
    </script>
</body>
</html> 