<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LomisX3 èªè­‰ç‹€æ…‹ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .test-result {
            background: #fff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .success { border-left: 4px solid #28a745; }
        .warning { border-left: 4px solid #ffc107; }
        .error { border-left: 4px solid #dc3545; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .code {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ LomisX3 èªè­‰ç‹€æ…‹ä¿®å¾©æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ æ¸¬è©¦é …ç›®æ¸…å–®</h2>
        <ol>
            <li><strong>AuthStore V6.2 ä¿®å¾©é©—è­‰</strong> - æª¢æŸ¥ç‹€æ…‹æ¢å¾©é‚è¼¯</li>
            <li><strong>localStorage åŒæ­¥æ¸¬è©¦</strong> - é©—è­‰ Token åŒæ­¥æ©Ÿåˆ¶</li>
            <li><strong>é é¢åˆ·æ–°æ¸¬è©¦</strong> - æ¨¡æ“¬åˆ·æ–°å¾Œç‹€æ…‹ä¿æŒ</li>
            <li><strong>éŒ¯èª¤è™•ç†æ¸¬è©¦</strong> - é©—è­‰ç•°å¸¸æƒ…æ³è™•ç†</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª æ¸¬è©¦ 1: AuthStore ç‹€æ…‹æ¨¡æ“¬</h2>
        <p>æ¨¡æ“¬ Zustand AuthStore çš„ç‹€æ…‹æ¢å¾©é‚è¼¯</p>
        
        <button onclick="testAuthStoreLogic()">åŸ·è¡Œ AuthStore é‚è¼¯æ¸¬è©¦</button>
        <div id="authStoreResult" class="test-result"></div>
        
        <div class="code">
            <strong>ä¿®å¾©é‡é»ï¼š</strong><br>
            âœ… initialize() æ–¹æ³•å®Œæ•´ç‹€æ…‹æª¢æŸ¥<br>
            âœ… localStorage å’Œ persist ç‹€æ…‹åŒæ­¥<br>
            âœ… éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„<br>
            âœ… åˆå§‹ isLoading: true é¿å…é–ƒçˆ
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ æ¸¬è©¦ 2: é é¢åˆ·æ–°æ¨¡æ“¬</h2>
        <p>æ¨¡æ“¬ç”¨æˆ¶ç™»å…¥å¾Œåˆ·æ–°é é¢çš„æƒ…æ³</p>
        
        <button onclick="simulateLogin()">1. æ¨¡æ“¬ç™»å…¥</button>
        <button onclick="simulateRefresh()">2. æ¨¡æ“¬é é¢åˆ·æ–°</button>
        <button onclick="clearStorage()">æ¸…é™¤å„²å­˜</button>
        
        <div id="refreshResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>âš ï¸ æ¸¬è©¦ 3: ç•°å¸¸æƒ…æ³è™•ç†</h2>
        <p>æ¸¬è©¦å„ç¨®ç•°å¸¸æƒ…æ³çš„è™•ç†</p>
        
        <button onclick="testExpiredToken()">éæœŸ Token æ¸¬è©¦</button>
        <button onclick="testMalformedToken()">ç„¡æ•ˆ Token æ¸¬è©¦</button>
        <button onclick="testMissingUser()">ç¼ºå¤±ä½¿ç”¨è€…è³‡è¨Šæ¸¬è©¦</button>
        
        <div id="errorResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š æ¸¬è©¦çµæœç¸½çµ</h2>
        <div id="summaryResult" class="test-result">
            <p>è«‹åŸ·è¡Œä¸Šè¿°æ¸¬è©¦ä»¥æŸ¥çœ‹çµæœ...</p>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬ AuthUtils
        const AuthUtils = {
            isTokenExpired: (token) => {
                try {
                    if (!token || typeof token !== 'string' || token.split('.').length !== 3) {
                        return true;
                    }
                    // ç°¡åŒ–çš„éæœŸæª¢æŸ¥
                    if (token === 'expired_token') return true;
                    if (token === 'malformed_token') return true;
                    return false;
                } catch (error) {
                    return true;
                }
            }
        };

        // æ¨¡æ“¬ localStorage
        let mockLocalStorage = {};
        let mockPersistState = {};

        // æ¸¬è©¦ 1: AuthStore é‚è¼¯æ¸¬è©¦
        function testAuthStoreLogic() {
            const result = document.getElementById('authStoreResult');
            let testResults = [];

            // æ¸¬è©¦æƒ…æ³ 1: å®Œæ•´ç‹€æ…‹æ¢å¾©
            testResults.push(testScenario1());
            
            // æ¸¬è©¦æƒ…æ³ 2: Token è£œå…¨
            testResults.push(testScenario2());
            
            // æ¸¬è©¦æƒ…æ³ 3: ç‹€æ…‹æ¸…é™¤
            testResults.push(testScenario3());

            result.innerHTML = `
                <h4>ğŸ“ˆ AuthStore é‚è¼¯æ¸¬è©¦çµæœ</h4>
                ${testResults.join('')}
                <p><strong>çµè«–ï¼š</strong> ${testResults.filter(r => r.includes('âœ…')).length}/3 å€‹æ¸¬è©¦é€šé</p>
            `;
            result.className = 'test-result success';
        }

        function testScenario1() {
            // æƒ…æ³ 1: localStorage æœ‰ tokenï¼Œpersist æœ‰å®Œæ•´ç‹€æ…‹
            const token = 'valid_token_123';
            const user = { id: 1, display_name: 'æ¸¬è©¦ä½¿ç”¨è€…', role: 'admin' };
            
            if (token && !AuthUtils.isTokenExpired(token)) {
                if (user && token === token) {
                    return '<p>âœ… <strong>æƒ…æ³ 1</strong>: å®Œæ•´ç‹€æ…‹æ¢å¾© - æˆåŠŸ</p>';
                }
            }
            return '<p>âŒ <strong>æƒ…æ³ 1</strong>: å®Œæ•´ç‹€æ…‹æ¢å¾© - å¤±æ•—</p>';
        }

        function testScenario2() {
            // æƒ…æ³ 2: localStorage æœ‰ tokenï¼Œpersist æœ‰ä½¿ç”¨è€…ä½† token ä¸åŒæ­¥
            const localToken = 'valid_token_456';
            const user = { id: 1, display_name: 'æ¸¬è©¦ä½¿ç”¨è€…', role: 'admin' };
            const persistToken = null;
            
            if (localToken && !AuthUtils.isTokenExpired(localToken)) {
                if (user && !persistToken) {
                    return '<p>âœ… <strong>æƒ…æ³ 2</strong>: Token è£œå…¨ - æˆåŠŸ</p>';
                }
            }
            return '<p>âŒ <strong>æƒ…æ³ 2</strong>: Token è£œå…¨ - å¤±æ•—</p>';
        }

        function testScenario3() {
            // æƒ…æ³ 3: localStorage æœ‰ token ä½†æ²’æœ‰ä½¿ç”¨è€…è³‡è¨Š
            const token = 'orphan_token_789';
            const user = null;
            
            if (token && !AuthUtils.isTokenExpired(token)) {
                if (!user && token) {
                    return '<p>âœ… <strong>æƒ…æ³ 3</strong>: å­¤ç«‹ Token æ¸…é™¤ - æˆåŠŸ</p>';
                }
            }
            return '<p>âŒ <strong>æƒ…æ³ 3</strong>: å­¤ç«‹ Token æ¸…é™¤ - å¤±æ•—</p>';
        }

        // æ¸¬è©¦ 2: é é¢åˆ·æ–°æ¨¡æ“¬
        function simulateLogin() {
            const user = {
                id: 1,
                email: 'test@example.com',
                display_name: 'æ¸¬è©¦ç®¡ç†å“¡',
                role: 'admin'
            };
            const token = 'valid_session_token_' + Date.now();

            // æ¨¡æ“¬ç™»å…¥ï¼šåŒæ™‚è¨­ç½® localStorage å’Œ persist
            mockLocalStorage['auth_token'] = token;
            mockPersistState = {
                user: user,
                token: token,
                isAuthenticated: true,
                permissions: ['users.read', 'users.write'],
                roles: ['admin']
            };

            updateRefreshResult('ç™»å…¥æˆåŠŸ', 'âœ… ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œç‹€æ…‹å·²åŒæ­¥åˆ° localStorage å’Œ Zustand persist');
        }

        function simulateRefresh() {
            const result = document.getElementById('refreshResult');
            
            // æ¨¡æ“¬é é¢åˆ·æ–°ï¼šæª¢æŸ¥ç‹€æ…‹æ¢å¾©
            const token = mockLocalStorage['auth_token'];
            const state = mockPersistState;

            let message = '<h4>ğŸ”„ é é¢åˆ·æ–°æ¨¡æ“¬çµæœ</h4>';

            if (token && !AuthUtils.isTokenExpired(token)) {
                if (state.user && state.token === token) {
                    message += '<p>âœ… <strong>ç‹€æ…‹æ¢å¾©æˆåŠŸ</strong>: èªè­‰ç‹€æ…‹å·²å¾ persist æ¢å¾©</p>';
                    message += `<p>ğŸ‘¤ ä½¿ç”¨è€…: ${state.user.display_name}</p>`;
                    message += `<p>ğŸ”‘ Token: ${token.substring(0, 20)}...</p>`;
                    message += '<p>ğŸ¯ <strong>çµæœ</strong>: ç”¨æˆ¶ä¿æŒç™»å…¥ç‹€æ…‹ï¼Œä¸æœƒè·³è½‰åˆ°ç™»å…¥é </p>';
                    result.className = 'test-result success';
                } else {
                    message += '<p>âŒ <strong>ç‹€æ…‹ä¸ä¸€è‡´</strong>: éœ€è¦é‡æ–°ç™»å…¥</p>';
                    result.className = 'test-result error';
                }
            } else {
                message += '<p>âš ï¸ <strong>Token ç„¡æ•ˆ</strong>: å°‡å°å‘ç™»å…¥é </p>';
                result.className = 'test-result warning';
            }

            result.innerHTML = message;
        }

        function clearStorage() {
            mockLocalStorage = {};
            mockPersistState = {};
            updateRefreshResult('å„²å­˜å·²æ¸…é™¤', 'localStorage å’Œ persist ç‹€æ…‹å·²é‡è¨­');
        }

        function updateRefreshResult(title, message) {
            const result = document.getElementById('refreshResult');
            result.innerHTML = `<h4>ğŸ“± ${title}</h4><p>${message}</p>`;
            result.className = 'test-result';
        }

        // æ¸¬è©¦ 3: ç•°å¸¸æƒ…æ³è™•ç†
        function testExpiredToken() {
            const expiredToken = 'expired_token';
            const result = AuthUtils.isTokenExpired(expiredToken);
            
            updateErrorResult('éæœŸ Token æ¸¬è©¦', 
                result ? 'âœ… éæœŸ Token è¢«æ­£ç¢ºè­˜åˆ¥ä¸¦è™•ç†' : 'âŒ éæœŸ Token è™•ç†å¤±æ•—'
            );
        }

        function testMalformedToken() {
            const malformedToken = 'invalid.token';
            const result = AuthUtils.isTokenExpired(malformedToken);
            
            updateErrorResult('ç„¡æ•ˆ Token æ¸¬è©¦', 
                result ? 'âœ… ç„¡æ•ˆ Token è¢«æ­£ç¢ºè­˜åˆ¥ä¸¦è™•ç†' : 'âŒ ç„¡æ•ˆ Token è™•ç†å¤±æ•—'
            );
        }

        function testMissingUser() {
            const token = 'valid_token_but_no_user';
            const user = null;
            
            const shouldLogout = token && !AuthUtils.isTokenExpired(token) && !user;
            
            updateErrorResult('ç¼ºå¤±ä½¿ç”¨è€…è³‡è¨Šæ¸¬è©¦', 
                shouldLogout ? 'âœ… å­¤ç«‹ Token å°‡è¢«æ¸…é™¤ï¼Œè§¸ç™¼é‡æ–°ç™»å…¥' : 'âŒ ç•°å¸¸ç‹€æ…‹è™•ç†å¤±æ•—'
            );
        }

        function updateErrorResult(title, message) {
            const result = document.getElementById('errorResult');
            const isSuccess = message.includes('âœ…');
            result.innerHTML = `<h4>âš ï¸ ${title}</h4><p>${message}</p>`;
            result.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summaryResult');
            summary.innerHTML = `
                <h4>ğŸ“Š LomisX3 AuthStore V6.2 ä¿®å¾©é©—è­‰</h4>
                <p><strong>âœ… æ ¸å¿ƒä¿®å¾©é …ç›®ï¼š</strong></p>
                <ul>
                    <li>ä¿®å¾© initialize() æ–¹æ³•çš„ç‹€æ…‹æ¢å¾©é‚è¼¯</li>
                    <li>æ”¹å–„ localStorage å’Œ Zustand persist åŒæ­¥æ©Ÿåˆ¶</li>
                    <li>å¢åŠ å®Œæ•´éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„</li>
                    <li>å„ªåŒ–åˆå§‹è¼‰å…¥ç‹€æ…‹ï¼Œé¿å…é–ƒçˆæœªèªè­‰ç‹€æ…‹</li>
                    <li>å¢å¼· Token æ ¼å¼é©—è­‰å’Œå®‰å…¨æª¢æŸ¥</li>
                </ul>
                <p><strong>ğŸ¯ é æœŸæ•ˆæœï¼š</strong></p>
                <ul>
                    <li>ç™»å…¥å¾Œåˆ·æ–°é é¢ä¸æœƒè·³å›ç™»å…¥é </li>
                    <li>ç‹€æ…‹æ¢å¾©æ›´åŠ ç©©å®šå¯é </li>
                    <li>ç•°å¸¸æƒ…æ³å¾—åˆ°å¦¥å–„è™•ç†</li>
                    <li>ä½¿ç”¨è€…é«”é©—é¡¯è‘—æ”¹å–„</li>
                </ul>
                <p><strong>ğŸ›¡ï¸ å®‰å…¨å¢å¼·ï¼š</strong> Token æ ¼å¼é©—è­‰ã€ç‹€æ…‹ä¸€è‡´æ€§æª¢æŸ¥ã€éŒ¯èª¤æ™‚å®‰å…¨ç‹€æ…‹è¨­ç½®</p>
            `;
            summary.className = 'test-result success';
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæ‘˜è¦
        window.onload = function() {
            updateSummary();
        };
    </script>
</body>
</html> 