<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LomisX3 - æŒä¹…åŒ–èªè­‰ç‹€æ…‹ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            border: 2px solid;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border-color: #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border-color: #f5c6cb; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border-color: #bee5eb; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border-color: #ffeaa7; 
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .test-section {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .network-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ LomisX3 æŒä¹…åŒ–èªè­‰ç‹€æ…‹ä¿®å¾©æ¸¬è©¦</h1>
        <p>æ¸¬è©¦ AuthStore V6.9 çš„é©å‘½æ€§ initialize å‡½æ•¸ä¿®å¾©</p>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æ¸¬è©¦ç›®æ¨™</h2>
        <div class="info">
            <strong>V6.9 ä¿®å¾©é‡é»ï¼š</strong><br>
            âœ… initialize å‡½æ•¸æ”¹ç‚ºå®Œå…¨ä¿¡ä»»æŒä¹…åŒ–ç‹€æ…‹<br>
            âœ… ç§»é™¤ä¸å¿…è¦çš„é ç¨‹é©—è­‰ï¼Œæå‡å•Ÿå‹•é€Ÿåº¦<br>
            âœ… ä¿®å¾©å› ç¶²è·¯è«‹æ±‚å¤±æ•—å°è‡´çš„ç‹€æ…‹æ¸…ç©ºå•é¡Œ<br>
            âœ… å¾ async æ”¹ç‚ºåŒæ­¥å‡½æ•¸ï¼Œæ¶ˆé™¤ç«¶æ…‹æ¢ä»¶
        </div>

        <!-- æ¸¬è©¦æ­¥é©Ÿ -->
        <div class="test-section">
            <h3>ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ</h3>
            <ol>
                <li><strong>æ­£å¸¸ç™»å…¥ï¼š</strong>ä½¿ç”¨æ­£ç¢ºå¸³å¯†ç™»å…¥ LomisX3 ç³»çµ±</li>
                <li><strong>ç¢ºèªç‹€æ…‹ï¼š</strong>ç™»å…¥æˆåŠŸå¾Œç¢ºèªå¯ä»¥æ­£å¸¸ä½¿ç”¨ç³»çµ±</li>
                <li><strong>é é¢åˆ·æ–°ï¼š</strong>æŒ‰ F5 æˆ– Ctrl+R åˆ·æ–°é é¢</li>
                <li><strong>ç‹€æ…‹é©—è­‰ï¼š</strong>åˆ·æ–°å¾Œæ‡‰è©²ç«‹å³æ¢å¾©èªè­‰ç‹€æ…‹ï¼Œç„¡éœ€é‡æ–°ç™»å…¥</li>
                <li><strong>é€Ÿåº¦æ¸¬è©¦ï¼š</strong>è§€å¯Ÿå•Ÿå‹•æ™‚é–“ï¼Œæ‡‰è©²æ˜é¡¯æ›´å¿«</li>
            </ol>
        </div>

        <!-- å¿«é€Ÿæ¸¬è©¦å·¥å…· -->
        <div class="test-section">
            <h3>âš¡ å¿«é€Ÿæ¸¬è©¦å·¥å…·</h3>
            <button class="btn" onclick="testLocalStorage()">ğŸ“± æª¢æŸ¥æœ¬åœ°å„²å­˜</button>
            <button class="btn" onclick="testAuthState()">ğŸ” æª¢æŸ¥èªè­‰ç‹€æ…‹</button>
            <button class="btn" onclick="simulateRefresh()">ğŸ”„ æ¨¡æ“¬é é¢åˆ·æ–°</button>
            <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            
            <div id="testResults"></div>
        </div>

        <!-- ç¶²è·¯ç›£æ§ -->
        <div class="test-section">
            <h3>ğŸ“¡ ç¶²è·¯è«‹æ±‚ç›£æ§</h3>
            <div class="warning">
                <strong>é‡è¦ï¼š</strong>åœ¨ V6.9 ç‰ˆæœ¬ä¸­ï¼Œé é¢åˆ·æ–°æ™‚æ‡‰è©²<strong>ä¸æœƒ</strong>ç™¼é€ /api/auth/me è«‹æ±‚ï¼
            </div>
            <button class="btn" onclick="monitorNetworkRequests()">ğŸ” é–‹å§‹ç›£æ§ç¶²è·¯è«‹æ±‚</button>
            <button class="btn" onclick="refreshPageTest()">ğŸ”„ åŸ·è¡Œåˆ·æ–°æ¸¬è©¦</button>
            
            <div id="networkResults"></div>
        </div>

        <!-- æ•ˆèƒ½æ¯”è¼ƒ -->
        <div class="test-section">
            <h3>âš¡ æ•ˆèƒ½æ¯”è¼ƒ</h3>
            <div class="code-block">
V6.8 (èˆŠç‰ˆæœ¬):
1. è®€å– localStorage token
2. ç™¼é€ /api/auth/me è«‹æ±‚ (200-500ms)
3. ç­‰å¾…ç¶²è·¯å›æ‡‰
4. è§£æç”¨æˆ¶è³‡æ–™
5. æ›´æ–°ç‹€æ…‹

V6.9 (æ–°ç‰ˆæœ¬):
1. è®€å– persist ç‹€æ…‹ (1-2ms)
2. ç›´æ¥è¨­å®šèªè­‰ç‹€æ…‹
3. å®Œæˆåˆå§‹åŒ– âœ…
            </div>
            <button class="btn" onclick="performanceTest()">ğŸ“Š åŸ·è¡Œæ•ˆèƒ½æ¸¬è©¦</button>
            <div id="performanceResults"></div>
        </div>

        <!-- æ¸¬è©¦çµæœ -->
        <div class="test-section">
            <h3>ğŸ“Š æ¸¬è©¦çµæœè¨˜éŒ„</h3>
            <div id="overallResults"></div>
        </div>
    </div>

    <script>
        let networkRequests = [];
        let originalFetch = window.fetch;

        // ç¶²è·¯è«‹æ±‚ç›£æ§
        function monitorNetworkRequests() {
            networkRequests = [];
            
            window.fetch = function(...args) {
                const url = args[0];
                const startTime = performance.now();
                
                networkRequests.push({
                    url: url,
                    timestamp: new Date().toLocaleTimeString(),
                    startTime: startTime
                });
                
                return originalFetch.apply(this, args).then(response => {
                    const endTime = performance.now();
                    const lastRequest = networkRequests[networkRequests.length - 1];
                    lastRequest.duration = Math.round(endTime - startTime);
                    lastRequest.status = response.status;
                    
                    updateNetworkResults();
                    return response;
                });
            };
            
            document.getElementById('networkResults').innerHTML = 
                '<div class="info">âœ… ç¶²è·¯ç›£æ§å·²å•Ÿå‹•ï¼Œè«‹åŸ·è¡Œæ“ä½œ...</div>';
        }

        function updateNetworkResults() {
            const results = document.getElementById('networkResults');
            let html = '<div class="info">ğŸ“¡ ç›£æ§åˆ°çš„ç¶²è·¯è«‹æ±‚ï¼š</div>';
            
            if (networkRequests.length === 0) {
                html += '<div class="success">ğŸ‰ æ²’æœ‰ç™¼é€ä»»ä½•ç¶²è·¯è«‹æ±‚ï¼é€™æ˜¯ V6.9 çš„é æœŸè¡Œç‚ºã€‚</div>';
            } else {
                networkRequests.forEach(req => {
                    const isAuthMe = req.url.includes('/api/auth/me');
                    const className = isAuthMe ? 'error' : 'info';
                    html += `<div class="${className}">
                        <strong>${req.timestamp}:</strong> ${req.url}<br>
                        <small>ç‹€æ…‹: ${req.status || 'å¾…å®š'} | è€—æ™‚: ${req.duration || 'å¾…å®š'}ms</small>
                    </div>`;
                });
            }
            
            results.innerHTML = html;
        }

        // æ¸¬è©¦æœ¬åœ°å„²å­˜
        function testLocalStorage() {
            const results = document.getElementById('testResults');
            let html = '<div class="info"><strong>ğŸ“± æœ¬åœ°å„²å­˜æª¢æŸ¥çµæœï¼š</strong></div>';
            
            // æª¢æŸ¥ auth_token
            const token = localStorage.getItem('auth_token');
            html += `<div class="${token ? 'success' : 'warning'}">
                Auth Token: ${token ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}
            </div>`;
            
            // æª¢æŸ¥ Zustand persist è³‡æ–™
            const authStorage = localStorage.getItem('auth-storage');
            if (authStorage) {
                try {
                    const parsed = JSON.parse(authStorage);
                    html += `<div class="success">
                        âœ… Zustand Persist è³‡æ–™å­˜åœ¨<br>
                        <small>User: ${parsed.state?.user?.name || 'æœªè¨­å®š'}</small><br>
                        <small>Token: ${parsed.state?.token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</small><br>
                        <small>Permissions: ${parsed.state?.permissions?.length || 0} å€‹</small>
                    </div>`;
                } catch (e) {
                    html += '<div class="error">âŒ Zustand Persist è³‡æ–™è§£æå¤±æ•—</div>';
                }
            } else {
                html += '<div class="warning">âš ï¸ Zustand Persist è³‡æ–™ä¸å­˜åœ¨</div>';
            }
            
            results.innerHTML = html;
        }

        // æ¸¬è©¦èªè­‰ç‹€æ…‹
        function testAuthState() {
            const results = document.getElementById('testResults');
            
            // é€™è£¡éœ€è¦é€é console æˆ–å…¶ä»–æ–¹å¼æª¢æŸ¥ React ç‹€æ…‹
            const html = `<div class="info">
                <strong>ğŸ” èªè­‰ç‹€æ…‹æª¢æŸ¥ï¼š</strong><br>
                è«‹æ‰“é–‹é–‹ç™¼è€…å·¥å…· Consoleï¼ŒæŸ¥çœ‹èªè­‰ç‹€æ…‹ç›¸é—œçš„æ—¥èªŒè¨Šæ¯ã€‚<br>
                <small>æç¤ºï¼šV6.9 ç‰ˆæœ¬æ‡‰è©²æœƒé¡¯ç¤º "[AUTH_INIT] å¾æŒä¹…åŒ–å„²å­˜ä¸­æˆåŠŸæ¢å¾©èªè­‰ç‹€æ…‹"</small>
            </div>`;
            
            results.innerHTML = html;
        }

        // æ¨¡æ“¬é é¢åˆ·æ–°
        function simulateRefresh() {
            if (confirm('ç¢ºå®šè¦åˆ·æ–°é é¢æ¸¬è©¦å—ï¼Ÿé€™å°‡é‡æ–°è¼‰å…¥æ•´å€‹æ‡‰ç”¨ç¨‹å¼ã€‚')) {
                window.location.reload();
            }
        }

        // é é¢åˆ·æ–°æ¸¬è©¦
        function refreshPageTest() {
            const results = document.getElementById('networkResults');
            results.innerHTML = '<div class="warning">â³ æ­£åœ¨åŸ·è¡Œåˆ·æ–°æ¸¬è©¦ï¼Œè«‹ç­‰å¾…...</div>';
            
            // è¨˜éŒ„é–‹å§‹æ™‚é–“
            const startTime = performance.now();
            
            setTimeout(() => {
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                let html = `<div class="info">
                    <strong>ğŸ”„ é é¢åˆ·æ–°æ¸¬è©¦çµæœï¼š</strong><br>
                    æ¸¬è©¦æŒçºŒæ™‚é–“: ${duration}ms<br>
                </div>`;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ /api/auth/me è«‹æ±‚
                const authMeRequests = networkRequests.filter(req => 
                    req.url.includes('/api/auth/me')
                );
                
                if (authMeRequests.length === 0) {
                    html += '<div class="success">ğŸ‰ å®Œç¾ï¼æ²’æœ‰ç™¼é€ä¸å¿…è¦çš„ /api/auth/me è«‹æ±‚</div>';
                } else {
                    html += `<div class="error">âŒ ç™¼ç¾ ${authMeRequests.length} å€‹ /api/auth/me è«‹æ±‚ï¼Œé€™è¡¨ç¤ºä¿®å¾©å¯èƒ½æœªç”Ÿæ•ˆ</div>`;
                }
                
                results.innerHTML = html;
            }, 2000);
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰èªè­‰è³‡æ–™å—ï¼Ÿé€™å°‡ç™»å‡ºç”¨æˆ¶ã€‚')) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('auth-storage');
                
                const results = document.getElementById('testResults');
                results.innerHTML = '<div class="success">âœ… æ‰€æœ‰èªè­‰è³‡æ–™å·²æ¸…é™¤</div>';
            }
        }

        // æ•ˆèƒ½æ¸¬è©¦
        function performanceTest() {
            const results = document.getElementById('performanceResults');
            
            const startTime = performance.now();
            
            // æ¨¡æ“¬ V6.9 çš„åˆå§‹åŒ–éç¨‹
            const authStorage = localStorage.getItem('auth-storage');
            const token = localStorage.getItem('auth_token');
            
            let initTime = 0;
            if (authStorage && token) {
                try {
                    JSON.parse(authStorage);
                    initTime = performance.now() - startTime;
                } catch (e) {
                    initTime = -1;
                }
            }
            
            let html = '<div class="info"><strong>âš¡ æ•ˆèƒ½æ¸¬è©¦çµæœï¼š</strong></div>';
            
            if (initTime >= 0) {
                html += `<div class="success">
                    âœ… æ¨¡æ“¬åˆå§‹åŒ–å®Œæˆæ™‚é–“: ${initTime.toFixed(2)}ms<br>
                    <small>V6.9 é æœŸæ•ˆèƒ½ï¼š&lt; 5ms (æ¥µå¿«)</small>
                </div>`;
                
                if (initTime < 5) {
                    html += '<div class="success">ğŸš€ æ•ˆèƒ½å„ªç§€ï¼ç¬¦åˆ V6.9 é æœŸç›®æ¨™</div>';
                } else if (initTime < 20) {
                    html += '<div class="warning">âš ï¸ æ•ˆèƒ½è‰¯å¥½ï¼Œä½†å¯ä»¥æ›´å¿«</div>';
                } else {
                    html += '<div class="error">âŒ æ•ˆèƒ½éœ€è¦å„ªåŒ–</div>';
                }
            } else {
                html += '<div class="warning">âš ï¸ ç„¡æ³•åŸ·è¡Œæ¸¬è©¦ï¼Œè«‹å…ˆç™»å…¥ç³»çµ±</div>';
            }
            
            results.innerHTML = html;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                testLocalStorage();
                monitorNetworkRequests();
            }, 1000);
        });

        // è¨˜éŒ„æ•´é«”æ¸¬è©¦çµæœ
        function updateOverallResults() {
            const results = document.getElementById('overallResults');
            const now = new Date().toLocaleString();
            
            results.innerHTML = `<div class="info">
                <strong>ğŸ“Š æ¸¬è©¦åŸ·è¡Œæ™‚é–“ï¼š</strong> ${now}<br>
                <strong>ğŸ¯ æ¸¬è©¦ç‰ˆæœ¬ï¼š</strong> AuthStore V6.9<br>
                <strong>âœ… ä¸»è¦é©—è­‰ï¼š</strong> æŒä¹…åŒ–ç‹€æ…‹æ¢å¾© + ç„¡ä¸å¿…è¦ç¶²è·¯è«‹æ±‚
            </div>`;
        }

        updateOverallResults();
    </script>
</body>
</html> 