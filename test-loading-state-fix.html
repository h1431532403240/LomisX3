<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LomisX3 - è¼‰å…¥ç‹€æ…‹ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            border: 2px solid;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border-color: #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border-color: #f5c6cb; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border-color: #ffeaa7; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border-color: #bee5eb; 
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6c757d;
            transform: none;
            cursor: not-allowed;
        }
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        h1, h2 {
            color: #2d3748;
            text-align: center;
        }
        h3 {
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .timeline {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .loading-demo {
            background: #2d3748;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ LomisX3 è¼‰å…¥ç‹€æ…‹ä¿®å¾©æ¸¬è©¦</h1>
        <p style="text-align: center; color: #666;">æ¸¬è©¦é é¢åˆ·æ–°æ™‚çš„è¼‰å…¥ç‹€æ…‹å’Œ UI ä¸€è‡´æ€§</p>

        <!-- å•é¡Œèªªæ˜ -->
        <div class="test-section">
            <h3>âŒ ä¿®å¾©å‰çš„å•é¡Œ</h3>
            <div class="status error">
                <strong>å•é¡Œæè¿°ï¼š</strong><br>
                â€¢ é é¢åˆ·æ–°å¾Œï¼Œæœƒæœ‰çŸ­æš«çš„æ™‚é–“é¡¯ç¤ºéŒ¯èª¤çš„ UI ç‹€æ…‹<br>
                â€¢ ä½¿ç”¨è€…å¯èƒ½çœ‹åˆ°ç™»å…¥é é¢æˆ–æœªèªè­‰ç‹€æ…‹çš„é–ƒçˆ<br>
                â€¢ AuthStore.initialize() æ˜¯ç•°æ­¥çš„ï¼Œä½† UI æ²’æœ‰ç­‰å¾…å…¶å®Œæˆ<br>
                â€¢ å°è‡´èªè­‰ç‹€æ…‹æª¢æŸ¥æ™‚å‡ºç¾ç«¶æ…‹æ¢ä»¶ (Race Condition)
            </div>
        </div>

        <!-- è§£æ±ºæ–¹æ¡ˆ -->
        <div class="test-section">
            <h3>âœ… ä¿®å¾©æ–¹æ¡ˆ</h3>
            <div class="status success">
                <strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>
                1. åœ¨ App.tsx ä¸­è®€å– authStore çš„ isLoading ç‹€æ…‹<br>
                2. ç•¶ isLoading = true æ™‚ï¼Œé¡¯ç¤ºå…¨é è¼‰å…¥ç•«é¢<br>
                3. åªæœ‰åœ¨ initialize() å®Œæˆå¾Œï¼Œæ‰æ¸²æŸ“ä¸»è¦æ‡‰ç”¨å…§å®¹<br>
                4. é˜²æ­¢ UI ç‹€æ…‹ä¸ä¸€è‡´å’Œé–ƒçˆå•é¡Œ
            </div>
        </div>

        <!-- è¼‰å…¥æµç¨‹æ¼”ç¤º -->
        <div class="test-section">
            <h3>ğŸ”„ è¼‰å…¥æµç¨‹æ¼”ç¤º</h3>
            <div class="timeline">
                <strong>ä¿®å¾©å¾Œçš„è¼‰å…¥æµç¨‹ï¼š</strong><br><br>
                1. ç”¨æˆ¶åˆ·æ–°é é¢ â†’ App.tsx è¼‰å…¥<br>
                2. useAuthStore() è®€å– isLoading ç‹€æ…‹<br>
                3. isLoading = true â†’ é¡¯ç¤ºè¼‰å…¥ç•«é¢<br>
                4. useEffect è§¸ç™¼ initialize() åŸ·è¡Œ<br>
                5. initialize() æª¢æŸ¥ localStorage ä¸­çš„ token<br>
                6. å¦‚æœ‰ token â†’ èª¿ç”¨ /api/auth/me é©—è­‰<br>
                7. é©—è­‰æˆåŠŸ â†’ è¨­å®š user, isAuthenticated = true<br>
                8. initialize() å®Œæˆ â†’ isLoading = false<br>
                9. è¼‰å…¥ç•«é¢æ¶ˆå¤± â†’ æ¸²æŸ“ä¸»è¦æ‡‰ç”¨å…§å®¹<br>
                10. ProtectedRoute æª¢æŸ¥ isAuthenticated<br>
                11. èªè­‰é€šé â†’ é¡¯ç¤ºä¸»é é¢
            </div>
        </div>

        <!-- è¼‰å…¥ç•«é¢é è¦½ -->
        <div class="test-section">
            <h3>ğŸ‘ï¸ è¼‰å…¥ç•«é¢é è¦½</h3>
            <div class="loading-demo">
                <div class="spinner"></div>
                æ­£åœ¨åˆå§‹åŒ–èªè­‰ç³»çµ±...
            </div>
            <div class="status info">
                <strong>è¼‰å…¥ç•«é¢ç‰¹è‰²ï¼š</strong><br>
                â€¢ å…¨å±è¦†è“‹ï¼Œé˜²æ­¢å…¶ä»–å…§å®¹é–ƒçˆ<br>
                â€¢ ä½¿ç”¨ shadcn/ui LoadingSpinner çµ„ä»¶<br>
                â€¢ æ”¯æ´ä¸»é¡Œæ¨¡å¼ (æ˜æš—åˆ‡æ›)<br>
                â€¢ å‹å¥½çš„è¼‰å…¥æç¤ºæ–‡å­—<br>
                â€¢ æµæš¢çš„æ—‹è½‰å‹•ç•«æ•ˆæœ
            </div>
        </div>

        <!-- å¯¦éš›æ¸¬è©¦æ­¥é©Ÿ -->
        <div class="test-section">
            <h3>ğŸ§ª å¯¦éš›æ¸¬è©¦æ­¥é©Ÿ</h3>
            <div class="status warning">
                <strong>æ¸¬è©¦æ–¹æ³•ï¼š</strong><br><br>
                1. <strong>ç¢ºä¿å¾Œç«¯æ­£å¸¸é‹è¡Œï¼š</strong>
                   <button onclick="testBackend()">ğŸ”§ æ¸¬è©¦å¾Œç«¯é€£ç·š</button>
                   <div id="backendResult"></div>
                <br><br>
                2. <strong>åŸ·è¡Œç™»å…¥æµç¨‹ï¼š</strong>
                   <button onclick="testLogin()">ğŸ”‘ æ¸¬è©¦ç™»å…¥</button>
                   <div id="loginResult"></div>
                <br><br>
                3. <strong>å‰ç«¯é‡æ–°è¼‰å…¥ï¼š</strong>
                   <button onclick="testFrontendReload()">ğŸ”„ é–‹å•Ÿå‰ç«¯æ‡‰ç”¨</button>
                   <div id="reloadResult"></div>
                <br><br>
                4. <strong>è§€å¯Ÿè¼‰å…¥ç‹€æ…‹ï¼š</strong><br>
                   â€¢ æ‡‰è©²çœ‹åˆ° "æ­£åœ¨åˆå§‹åŒ–èªè­‰ç³»çµ±..." è¼‰å…¥ç•«é¢<br>
                   â€¢ è¼‰å…¥å®Œæˆå¾Œç›´æ¥é€²å…¥ä¸»é é¢<br>
                   â€¢ ä¸æ‡‰è©²æœ‰é–ƒçˆæˆ–è·³è½‰åˆ°ç™»å…¥é é¢
            </div>
        </div>

        <!-- ä¿®æ”¹çš„æª”æ¡ˆåˆ—è¡¨ -->
        <div class="test-section">
            <h3>ğŸ“ ä¿®æ”¹çš„æª”æ¡ˆ</h3>
            <div class="timeline">
                <strong>front/src/App.tsx v4.4.0ï¼š</strong><br>
                + import { LoadingSpinner } from '@/components/common/loading-spinner';<br>
                + const { initialize, isLoading } = useAuthStore();<br>
                + if (isLoading) { return &lt;LoadingSpinner ... /&gt; }<br><br>
                
                <strong>å·²å­˜åœ¨çš„å…ƒä»¶ï¼š</strong><br>
                âœ… front/src/components/common/loading-spinner.tsx<br>
                âœ… front/src/stores/authStore.ts (isLoading ç‹€æ…‹ç®¡ç†)
            </div>
        </div>

        <!-- é æœŸæ•ˆæœ -->
        <div class="test-section">
            <h3>ğŸ¯ é æœŸæ•ˆæœ</h3>
            <div class="status success">
                <strong>ä¿®å¾©å¾Œçš„ç”¨æˆ¶é«”é©—ï¼š</strong><br>
                âœ… é é¢åˆ·æ–°æ™‚æœ‰æ˜ç¢ºçš„è¼‰å…¥æç¤º<br>
                âœ… ä¸æœƒå‡ºç¾èªè­‰ç‹€æ…‹é–ƒçˆ<br>
                âœ… ä¸æœƒçŸ­æš«é¡¯ç¤ºç™»å…¥é é¢<br>
                âœ… è¼‰å…¥å®Œæˆå¾Œç›´æ¥é¡¯ç¤ºæ­£ç¢ºçš„é é¢<br>
                âœ… ç¬¦åˆç¾ä»£ SPA æ‡‰ç”¨çš„ç”¨æˆ¶é«”é©—æ¨™æº–<br>
                âœ… æ”¯æ´æ·±è‰²/æ·ºè‰²ä¸»é¡Œåˆ‡æ›
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const FRONTEND_URL = 'http://localhost:5173';

        // æ¸¬è©¦å¾Œç«¯é€£ç·š
        async function testBackend() {
            const resultDiv = document.getElementById('backendResult');
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æ¸¬è©¦å¾Œç«¯é€£ç·š...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/test`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="status success">âœ… å¾Œç«¯é€£ç·šæ­£å¸¸ (${data.message})</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ å¾Œç«¯å›æ‡‰ç•°å¸¸ (${response.status})</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ å¾Œç«¯é€£ç·šå¤±æ•—ï¼š${error.message}</div>`;
            }
        }

        // æ¸¬è©¦ç™»å…¥
        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æ¸¬è©¦ç™»å…¥...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        login: 'admin@lomis.com',
                        password: 'password',
                        device_name: 'Test-Device'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    localStorage.setItem('auth_token', data.data.token);
                    resultDiv.innerHTML = `<div class="status success">âœ… ç™»å…¥æˆåŠŸï¼Token å·²ä¿å­˜åˆ° localStorage</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ ç™»å…¥å¤±æ•—ï¼š${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ ç™»å…¥éŒ¯èª¤ï¼š${error.message}</div>`;
            }
        }

        // é–‹å•Ÿå‰ç«¯æ‡‰ç”¨
        function testFrontendReload() {
            const resultDiv = document.getElementById('reloadResult');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ token
            const token = localStorage.getItem('auth_token');
            if (!token) {
                resultDiv.innerHTML = '<div class="status error">âŒ è«‹å…ˆåŸ·è¡Œç™»å…¥æ¸¬è©¦ä»¥ç²å– Token</div>';
                return;
            }
            
            resultDiv.innerHTML = `
                <div class="status info">
                    ğŸ”„ æº–å‚™é–‹å•Ÿå‰ç«¯æ‡‰ç”¨...<br><br>
                    <strong>æ¸¬è©¦æ­¥é©Ÿï¼š</strong><br>
                    1. é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•Ÿæ–°åˆ†é <br>
                    2. è§€å¯Ÿè¼‰å…¥éç¨‹ï¼Œæ‡‰è©²çœ‹åˆ°è¼‰å…¥ç•«é¢<br>
                    3. ç¢ºèªè¼‰å…¥å®Œæˆå¾Œç›´æ¥é€²å…¥ä¸»é é¢<br>
                    4. å¤šæ¬¡åˆ·æ–°æ¸¬è©¦è¼‰å…¥ç‹€æ…‹çš„ä¸€è‡´æ€§<br><br>
                    <button onclick="window.open('${FRONTEND_URL}', '_blank')" 
                            style="background: #28a745; padding: 10px 20px;">
                        ğŸš€ é–‹å•Ÿ LomisX3 å‰ç«¯æ‡‰ç”¨
                    </button>
                </div>
            `;
        }

        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹ç‹€æ…‹æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                document.getElementById('backendResult').innerHTML = 
                    '<div class="status info">ğŸ’¡ ç™¼ç¾å·²å„²å­˜çš„ Tokenï¼Œå¯ä»¥ç›´æ¥æ¸¬è©¦è¼‰å…¥ç‹€æ…‹</div>';
            }
        });
    </script>
</body>
</html> 