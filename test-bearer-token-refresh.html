<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LomisX3 - Bearer Token åˆ·æ–°æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            border: 2px solid;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border-color: #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border-color: #f5c6cb; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border-color: #ffeaa7; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border-color: #bee5eb; 
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6c757d;
            transform: none;
            cursor: not-allowed;
        }
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        .token-display {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        h1, h2 {
            color: #2d3748;
            text-align: center;
        }
        h3 {
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .user-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” LomisX3 Bearer Token åˆ·æ–°æ¸¬è©¦</h1>
        <p style="text-align: center; color: #666;">æ¸¬è©¦ç™»å…¥å¾Œåˆ·æ–°é é¢çš„èªè­‰ç‹€æ…‹æ¢å¾©åŠŸèƒ½</p>

        <!-- Token ç‹€æ…‹é¡¯ç¤º -->
        <div class="test-section">
            <h3>ğŸ¯ Token ç‹€æ…‹</h3>
            <div id="tokenStatus" class="info">
                ğŸ“‹ è«‹å…ˆç™»å…¥ä»¥ç²å– Bearer Token
            </div>
            <div id="tokenDisplay" class="token-display" style="display: none;">
                Token å°‡åœ¨æ­¤é¡¯ç¤º...
            </div>
        </div>

        <!-- ç™»å…¥æ¸¬è©¦ -->
        <div class="test-section">
            <h3>1ï¸âƒ£ ç™»å…¥æ¸¬è©¦</h3>
            <div style="margin: 15px 0;">
                <input type="text" id="username" placeholder="ä½¿ç”¨è€…åç¨±æˆ–ä¿¡ç®±" style="padding: 10px; width: 200px; margin: 5px;">
                <input type="password" id="password" placeholder="å¯†ç¢¼" style="padding: 10px; width: 200px; margin: 5px;">
                <button onclick="testLogin()">ğŸ”‘ ç™»å…¥</button>
            </div>
            <div id="loginResult"></div>
        </div>

        <!-- /me ç«¯é»æ¸¬è©¦ -->
        <div class="test-section">
            <h3>2ï¸âƒ£ /me ç«¯é»æ¸¬è©¦</h3>
            <button onclick="testMeEndpoint()">ğŸ‘¤ æ¸¬è©¦ /me ç«¯é»</button>
            <button onclick="testMeWithoutToken()">âŒ æ¸¬è©¦ç„¡ Token è«‹æ±‚</button>
            <div id="meResult"></div>
            <div id="userInfo" class="user-info" style="display: none;">
                ç”¨æˆ¶è³‡è¨Šå°‡åœ¨æ­¤é¡¯ç¤º...
            </div>
        </div>

        <!-- é é¢åˆ·æ–°æ¨¡æ“¬ -->
        <div class="test-section">
            <h3>3ï¸âƒ£ é é¢åˆ·æ–°æ¨¡æ“¬</h3>
            <button onclick="simulatePageRefresh()">ğŸ”„ æ¨¡æ“¬é é¢åˆ·æ–°</button>
            <div id="refreshResult"></div>
        </div>

        <!-- Token ç®¡ç† -->
        <div class="test-section">
            <h3>4ï¸âƒ£ Token ç®¡ç†</h3>
            <button onclick="clearToken()">ğŸ—‘ï¸ æ¸…é™¤ Token</button>
            <button onclick="viewStoredToken()">ğŸ‘ï¸ æŸ¥çœ‹å„²å­˜çš„ Token</button>
            <div id="tokenManagementResult"></div>
        </div>

        <!-- ç¶œåˆæ¸¬è©¦ -->
        <div class="test-section">
            <h3>5ï¸âƒ£ ç¶œåˆæ¸¬è©¦æµç¨‹</h3>
            <button onclick="runFullTest()">ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹</button>
            <div id="fullTestResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let storedToken = null;

        // æ›´æ–° Token ç‹€æ…‹é¡¯ç¤º
        function updateTokenStatus() {
            const token = localStorage.getItem('auth_token');
            const statusDiv = document.getElementById('tokenStatus');
            const displayDiv = document.getElementById('tokenDisplay');
            
            if (token) {
                statusDiv.className = 'status success';
                statusDiv.textContent = `âœ… Token å·²å„²å­˜ (é•·åº¦: ${token.length} å­—å…ƒ)`;
                displayDiv.style.display = 'block';
                displayDiv.textContent = `Bearer ${token}`;
                storedToken = token;
            } else {
                statusDiv.className = 'status warning';
                statusDiv.textContent = 'âš ï¸ æœªæ‰¾åˆ° Tokenï¼Œè«‹å…ˆç™»å…¥';
                displayDiv.style.display = 'none';
                storedToken = null;
            }
        }

        // ç™»å…¥æ¸¬è©¦
        async function testLogin() {
            const username = document.getElementById('username').value || 'admin@lomis.com';
            const password = document.getElementById('password').value || 'password';
            const resultDiv = document.getElementById('loginResult');
            
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨å˜—è©¦ç™»å…¥...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        login: username,
                        password: password,
                        device_name: 'Test-Device'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    localStorage.setItem('auth_token', data.data.token);
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… ç™»å…¥æˆåŠŸï¼</div>
                        <div class="user-info">
                            <strong>ç”¨æˆ¶ï¼š</strong> ${data.data.user.name || data.data.user.username}<br>
                            <strong>è§’è‰²ï¼š</strong> ${data.data.user.role}<br>
                            <strong>æ¬Šé™æ•¸é‡ï¼š</strong> ${data.data.permissions?.length || 0}<br>
                            <strong>Token å‰ç¶´ï¼š</strong> ${data.data.token.substring(0, 20)}...
                        </div>
                    `;
                    updateTokenStatus();
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ ç™»å…¥å¤±æ•—ï¼š${data.message || 'æœªçŸ¥éŒ¯èª¤'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ ç¶²è·¯éŒ¯èª¤ï¼š${error.message}</div>`;
            }
        }

        // æ¸¬è©¦ /me ç«¯é»
        async function testMeEndpoint() {
            const token = localStorage.getItem('auth_token');
            const resultDiv = document.getElementById('meResult');
            const userInfoDiv = document.getElementById('userInfo');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="status error">âŒ è«‹å…ˆç™»å…¥ä»¥ç²å– Token</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æ¸¬è©¦ /me ç«¯é»...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.innerHTML = `<div class="status success">âœ… /me ç«¯é»æ­£å¸¸ï¼ç”¨æˆ¶å·²èªè­‰</div>`;
                    userInfoDiv.style.display = 'block';
                    userInfoDiv.innerHTML = `
                        <h4>ğŸ‘¤ ç”¨æˆ¶è³‡è¨Š</h4>
                        <strong>å§“åï¼š</strong> ${data.data.user.name || data.data.user.username}<br>
                        <strong>ä¿¡ç®±ï¼š</strong> ${data.data.user.email}<br>
                        <strong>è§’è‰²ï¼š</strong> ${data.data.user.role}<br>
                        <strong>é–€å¸‚ï¼š</strong> ${data.data.store?.name || 'æœªæŒ‡å®š'}<br>
                        <strong>æ¬Šé™ï¼š</strong> ${data.data.permissions?.join(', ') || 'ç„¡æ¬Šé™'}<br>
                        <strong>ç‹€æ…‹ï¼š</strong> ${response.status} ${response.statusText}
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ /me ç«¯é»å¤±æ•—ï¼š${data.message} (ç‹€æ…‹ç¢¼: ${response.status})</div>`;
                    userInfoDiv.style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ ç¶²è·¯éŒ¯èª¤ï¼š${error.message}</div>`;
                userInfoDiv.style.display = 'none';
            }
        }

        // æ¸¬è©¦ç„¡ Token è«‹æ±‚
        async function testMeWithoutToken() {
            const resultDiv = document.getElementById('meResult');
            
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æ¸¬è©¦ç„¡ Token è«‹æ±‚...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.status === 401) {
                    resultDiv.innerHTML = `<div class="status success">âœ… æ­£ç¢ºï¼ç„¡ Token è«‹æ±‚è¿”å› 401 (${data.message})</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status warning">âš ï¸ æ„å¤–å›æ‡‰ï¼šç‹€æ…‹ç¢¼ ${response.status}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ ç¶²è·¯éŒ¯èª¤ï¼š${error.message}</div>`;
            }
        }

        // æ¨¡æ“¬é é¢åˆ·æ–°
        async function simulatePageRefresh() {
            const resultDiv = document.getElementById('refreshResult');
            
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ¨¡æ“¬é é¢åˆ·æ–°æµç¨‹...</div>';
            
            // æ­¥é©Ÿ 1ï¼šæª¢æŸ¥ localStorage ä¸­çš„ Token
            const token = localStorage.getItem('auth_token');
            if (!token) {
                resultDiv.innerHTML = '<div class="status error">âŒ æ¨¡æ“¬å¤±æ•—ï¼šlocalStorage ä¸­æ²’æœ‰ Token</div>';
                return;
            }
            
            let steps = [`âœ… æ­¥é©Ÿ 1ï¼šå¾ localStorage è®€å– Token (å‰ç¶´: ${token.substring(0, 20)}...)`];
            
            // æ­¥é©Ÿ 2ï¼šé©—è­‰ Token æœ‰æ•ˆæ€§
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    steps.push('âœ… æ­¥é©Ÿ 2ï¼šToken é©—è­‰æˆåŠŸï¼Œç²å–ç”¨æˆ¶è³‡è¨Š');
                    steps.push(`âœ… æ­¥é©Ÿ 3ï¼šèªè­‰ç‹€æ…‹æ¢å¾©å®Œæˆ (ç”¨æˆ¶: ${data.data.user.name || data.data.user.username})`);
                    steps.push('ğŸ‰ é é¢åˆ·æ–°æ¨¡æ“¬æˆåŠŸï¼èªè­‰ç‹€æ…‹å·²æ­£ç¢ºæ¢å¾©');
                } else {
                    steps.push(`âŒ æ­¥é©Ÿ 2ï¼šToken é©—è­‰å¤±æ•— (${response.status})`);
                    steps.push('âŒ é é¢åˆ·æ–°æ¨¡æ“¬å¤±æ•—ï¼ç”¨æˆ¶å°‡è¢«é‡å®šå‘è‡³ç™»å…¥é ');
                }
            } catch (error) {
                steps.push(`âŒ æ­¥é©Ÿ 2ï¼šç¶²è·¯éŒ¯èª¤ (${error.message})`);
                steps.push('âŒ é é¢åˆ·æ–°æ¨¡æ“¬å¤±æ•—ï¼');
            }
            
            resultDiv.innerHTML = `<div class="status ${steps.join('').includes('âŒ') ? 'error' : 'success'}">${steps.join('<br>')}</div>`;
        }

        // æ¸…é™¤ Token
        function clearToken() {
            localStorage.removeItem('auth_token');
            document.getElementById('tokenManagementResult').innerHTML = '<div class="status success">âœ… Token å·²æ¸…é™¤</div>';
            updateTokenStatus();
        }

        // æŸ¥çœ‹å„²å­˜çš„ Token
        function viewStoredToken() {
            const token = localStorage.getItem('auth_token');
            const resultDiv = document.getElementById('tokenManagementResult');
            
            if (token) {
                resultDiv.innerHTML = `
                    <div class="status info">
                        ğŸ“‹ å„²å­˜çš„ Tokenï¼š<br>
                        <div class="token-display">${token}</div>
                        <small>æ ¼å¼æª¢æŸ¥ï¼š${token.includes('|') ? 'âœ… Sanctum æ ¼å¼æ­£ç¢º' : 'âŒ æ ¼å¼ç•°å¸¸'}</small>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = '<div class="status warning">âš ï¸ æ²’æœ‰å„²å­˜çš„ Token</div>';
            }
        }

        // åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹
        async function runFullTest() {
            const resultDiv = document.getElementById('fullTestResult');
            resultDiv.innerHTML = '<div class="status info">ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹...</div>';
            
            const steps = [];
            
            // æ­¥é©Ÿ 1ï¼šæ¸…é™¤ç¾æœ‰ Token
            localStorage.removeItem('auth_token');
            steps.push('1ï¸âƒ£ æ¸…é™¤ç¾æœ‰ Token');
            
            // æ­¥é©Ÿ 2ï¼šå˜—è©¦ç™»å…¥
            try {
                const loginResponse = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        login: 'admin@lomis.com',
                        password: 'password',
                        device_name: 'Full-Test-Device'
                    })
                });

                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    localStorage.setItem('auth_token', loginData.data.token);
                    steps.push('2ï¸âƒ£ âœ… ç™»å…¥æˆåŠŸï¼ŒToken å·²å„²å­˜');
                    
                    // æ­¥é©Ÿ 3ï¼šæ¸¬è©¦ /me ç«¯é»
                    const meResponse = await fetch(`${API_BASE}/api/auth/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${loginData.data.token}`,
                            'Accept': 'application/json',
                        }
                    });

                    if (meResponse.ok) {
                        steps.push('3ï¸âƒ£ âœ… /me ç«¯é»æ­£å¸¸å·¥ä½œ');
                        
                        // æ­¥é©Ÿ 4ï¼šæ¨¡æ“¬é é¢åˆ·æ–°
                        const refreshMeResponse = await fetch(`${API_BASE}/api/auth/me`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                                'Accept': 'application/json',
                            }
                        });

                        if (refreshMeResponse.ok) {
                            steps.push('4ï¸âƒ£ âœ… é é¢åˆ·æ–°å¾Œèªè­‰ç‹€æ…‹æ¢å¾©æˆåŠŸ');
                            steps.push('ğŸ‰ å®Œæ•´æ¸¬è©¦æµç¨‹é€šéï¼ç³»çµ±é‹ä½œæ­£å¸¸');
                        } else {
                            steps.push('4ï¸âƒ£ âŒ é é¢åˆ·æ–°å¾Œèªè­‰å¤±æ•—');
                        }
                    } else {
                        steps.push('3ï¸âƒ£ âŒ /me ç«¯é»å¤±æ•—');
                    }
                } else {
                    steps.push('2ï¸âƒ£ âŒ ç™»å…¥å¤±æ•—');
                }
            } catch (error) {
                steps.push(`âŒ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
            }
            
            resultDiv.innerHTML = `<div class="status ${steps.join('').includes('âŒ') ? 'error' : 'success'}">${steps.join('<br>')}</div>`;
            updateTokenStatus();
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTokenStatus();
            
            // è¨­å®šé è¨­ç™»å…¥æ†‘è­‰
            document.getElementById('username').value = 'admin@lomis.com';
            document.getElementById('password').value = 'password';
        });
    </script>
</body>
</html> 